
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>About Dataset And Features: &#8212; Veri Bilimi Portfolyosu</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_notebooks/LSTM_GRU_DeepAR_notebook';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/profile.png" class="logo__image only-light" alt="Veri Bilimi Portfolyosu - Home"/>
    <script>document.write(`<img src="../_static/profile.png" class="logo__image only-dark" alt="Veri Bilimi Portfolyosu - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Veri Bilimi Portfolyom/Anasayfa
                </a>
            </li>
        </ul>
        
    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/nazmclk/ds-portfolio/blob/master/_notebooks/LSTM_GRU_DeepAR_notebook.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>



<a href="https://github.com/nazmclk/ds-portfolio" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/_notebooks/LSTM_GRU_DeepAR_notebook.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>About Dataset And Features:</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#"><em><strong>About Dataset And Features:</strong></em></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-detailed-description-of-the-dataset-is-given-in-the-notebook-which-is-the-first-of-this-notebook-series-and-in-the-original-location-of-the-dataset-on-kaggle">A detailed description of the dataset is given in the notebook, which is the first of this notebook series, and in the original location of the dataset on Kaggle.</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#importing-libraries"><em><strong>1.Importing Libraries</strong></em></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-data"><em><strong>2.Reading Data</strong></em></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modeling"><em><strong>3.MODELING</strong></em></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-preparation"><em><strong>3.1. Model Preparation</strong></em></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-selection"><em><strong>3.2.Model Selection¶</strong></em></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lstm-long-short-term-memory"><em><strong>3.2.1.LSTM(Long Short Term Memory)</strong></em></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-results-don-t-look-bad-but"><strong>The results don’t look bad but</strong><br/></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#differecence-between-train-test-line-indicates-overfitting-so"><em><strong>Differecence between train-test line indicates overfitting, so</strong></em></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#i-think-it-is-enough-for-lstm"><strong>I think, it is enough for LSTM</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gru"><em><strong>3.2.2.Gru</strong></em></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#gru-gated-recurrent-unit-and-its-key-features"><em><strong><em>GRU (Gated Recurrent Unit) and Its Key Features</em></strong></em><br/><br/></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deepar-amazon-timeseries-algorithm"><em><strong>3.2.3.DeepAR(Amazon timeseries algorithm):</strong></em></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-defining"><em><strong>3.3.1.Model defining</strong></em><br/></a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#electricity-power-factor-forecast-analysis">Electricity Power Factor Forecast Analysis</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># IMPORTANT: SOME KAGGLE DATA SOURCES ARE PRIVATE</span>
<span class="c1"># RUN THIS CELL IN ORDER TO IMPORT YOUR KAGGLE DATA SOURCES.</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">kagglehub</span>
<span class="n">kagglehub</span><span class="o">.</span><span class="n">login</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># IMPORTANT: SOME KAGGLE DATA SOURCES ARE PRIVATE</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="c1"># RUN THIS CELL IN ORDER TO IMPORT YOUR KAGGLE DATA SOURCES.</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="kn">import</span><span class="w"> </span><span class="nn">kagglehub</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">kagglehub</span><span class="o">.</span><span class="n">login</span><span class="p">()</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;kagglehub&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># IMPORTANT: RUN THIS CELL IN ORDER TO IMPORT YOUR KAGGLE DATA SOURCES,</span>
<span class="c1"># THEN FEEL FREE TO DELETE THIS CELL.</span>
<span class="c1"># NOTE: THIS NOTEBOOK ENVIRONMENT DIFFERS FROM KAGGLE&#39;S PYTHON</span>
<span class="c1"># ENVIRONMENT SO THERE MAY BE MISSING LIBRARIES USED BY YOUR</span>
<span class="c1"># NOTEBOOK.</span>

<span class="n">organizations_uciml_electric_power_consumption_data_set_path</span> <span class="o">=</span> <span class="n">kagglehub</span><span class="o">.</span><span class="n">dataset_download</span><span class="p">(</span><span class="s1">&#39;organizations/uciml/electric-power-consumption-data-set&#39;</span><span class="p">)</span>
<span class="n">nazmclk_data_to_model_path</span> <span class="o">=</span> <span class="n">kagglehub</span><span class="o">.</span><span class="n">dataset_download</span><span class="p">(</span><span class="s1">&#39;nazmclk/data-to-model&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data source import complete.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">google.colab</span><span class="w"> </span><span class="kn">import</span> <span class="n">drive</span>
<span class="n">drive</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s1">&#39;/content/drive&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mounted at /content/drive
</pre></div>
</div>
</div>
</div>
<p><u><p style="font-size: 36px;font-weight: bold;font-style: oblique;text-indent: 30px;text-align: center;"><strong>Household Electric Power Consumption Forecasting</strong></p></u></p>
<p style="text-indent:30px;font-size:16px"> The real energy demand made on the present electrical supply is referred to as electric energy consumption. However, poor management of its use can result in a reduction in electrical supply. As a result, it is critical that everyone be concerned about energy efficiency in order to reduce consumption. The goals of this study are to develop a model for <strong>forecasting household electricity usage</strong> and to determine the best forecasting period, which could be daily, weekly, monthly, or quarterly. Individual household electricity power usage is the time-series data in our investigation.This Notebook use Deep Learning and time-series data analysis methods for this aim.<br></p>
<p style="text-indent:30px;font-size:16px;">Any household requires electricity to function. In this period of global instability, the globe requires rising amounts of energy to maintain economic and social progress and improve living standards. Mishandling of electric energy could result in future excessive costs. Over 60% of residential energy in the United States is wasted. Many people who use power on a regular basis are unaware of how much energy is wasted. In this notebook series, I want to use and compare some of the following DeepLearning models: <strong>Prophet – Facebook, ARIMA (Autoregressive Integrated Moving Average), XGBoost/LightGBM, LSTM (Long Short Term Memory), DeepAR (Amazon time series model) and transformer(TFT,PatchTST,ETSformer,FEDformer) mentioned in link below and N-Beats, N-HITS are also mentioned in the timeseries interested community.</strong><p/>
<p><a class="reference external" href="http://github.com/thuml/Time-Series-Library">“https://github.com/thuml/Time-Series-Library”</a></p>
<section id="about-dataset-and-features">
<h1><em><strong>About Dataset And Features:</strong></em><a class="headerlink" href="#about-dataset-and-features" title="Link to this heading">#</a></h1>
<section id="a-detailed-description-of-the-dataset-is-given-in-the-notebook-which-is-the-first-of-this-notebook-series-and-in-the-original-location-of-the-dataset-on-kaggle">
<h2>A detailed description of the dataset is given in the notebook, which is the first of this notebook series, and in the original location of the dataset on Kaggle.<a class="headerlink" href="#a-detailed-description-of-the-dataset-is-given-in-the-notebook-which-is-the-first-of-this-notebook-series-and-in-the-original-location-of-the-dataset-on-kaggle" title="Link to this heading">#</a></h2>
</section>
</section>
<section id="importing-libraries">
<h1><em><strong>1.Importing Libraries</strong></em><a class="headerlink" href="#importing-libraries" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let`s import all packages that we may need:</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pandas.tseries.frequencies</span><span class="w"> </span><span class="kn">import</span> <span class="n">to_offset</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TF_CPP_MIN_LOG_LEVEL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span>  <span class="c1"># To simplify TensorFlow logs</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_colwidth&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="reading-data">
<h1><em><strong>2.Reading Data</strong></em><a class="headerlink" href="#reading-data" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;/content/drive/MyDrive/Household_Electric_Consumption/df_before_modeling.csv&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span>
                 <span class="n">infer_datetime_format</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;dt&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-0ed515b3-a332-4576-be72-1f50df87d14a" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>voltage</th>
      <th>global_intensity</th>
      <th>sub_metering_1</th>
      <th>sub_metering_2</th>
      <th>sub_metering_3</th>
      <th>power_factor</th>
    </tr>
    <tr>
      <th>dt</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2006-12-16 17:24:00</th>
      <td>234.84</td>
      <td>18.4</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>17.0</td>
      <td>0.995121</td>
    </tr>
    <tr>
      <th>2006-12-16 17:25:00</th>
      <td>233.63</td>
      <td>23.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>16.0</td>
      <td>0.996708</td>
    </tr>
    <tr>
      <th>2006-12-16 17:26:00</th>
      <td>233.29</td>
      <td>23.0</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>17.0</td>
      <td>0.995734</td>
    </tr>
    <tr>
      <th>2006-12-16 17:27:00</th>
      <td>233.74</td>
      <td>23.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>17.0</td>
      <td>0.995688</td>
    </tr>
    <tr>
      <th>2006-12-16 17:28:00</th>
      <td>235.68</td>
      <td>15.8</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>17.0</td>
      <td>0.989787</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-0ed515b3-a332-4576-be72-1f50df87d14a')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-0ed515b3-a332-4576-be72-1f50df87d14a button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-0ed515b3-a332-4576-be72-1f50df87d14a');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-8bb23407-de6b-44c2-8c6a-79fd643d360a">
  <button class="colab-df-quickchart" onclick="quickchart('df-8bb23407-de6b-44c2-8c6a-79fd643d360a')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-8bb23407-de6b-44c2-8c6a-79fd643d360a button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div></div>
</div>
</section>
<section id="modeling">
<h1><em><strong>3.MODELING</strong></em><a class="headerlink" href="#modeling" title="Link to this heading">#</a></h1>
<section id="model-preparation">
<h2><em><strong>3.1. Model Preparation</strong></em><a class="headerlink" href="#model-preparation" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_hourly</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_hourly</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(34589, 6)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_hourly</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>voltage</th>
      <th>global_intensity</th>
      <th>sub_metering_1</th>
      <th>sub_metering_2</th>
      <th>sub_metering_3</th>
      <th>power_factor</th>
    </tr>
    <tr>
      <th>dt</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2006-12-16 17:00:00</th>
      <td>234.643889</td>
      <td>18.100000</td>
      <td>0.0</td>
      <td>0.527778</td>
      <td>16.861111</td>
      <td>0.997052</td>
    </tr>
    <tr>
      <th>2006-12-16 18:00:00</th>
      <td>234.580167</td>
      <td>15.600000</td>
      <td>0.0</td>
      <td>6.716667</td>
      <td>16.866667</td>
      <td>0.999518</td>
    </tr>
    <tr>
      <th>2006-12-16 19:00:00</th>
      <td>233.232500</td>
      <td>14.503333</td>
      <td>0.0</td>
      <td>1.433333</td>
      <td>16.683333</td>
      <td>0.999526</td>
    </tr>
    <tr>
      <th>2006-12-16 20:00:00</th>
      <td>234.071500</td>
      <td>13.916667</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>16.783333</td>
      <td>0.999569</td>
    </tr>
    <tr>
      <th>2006-12-16 21:00:00</th>
      <td>237.158667</td>
      <td>13.046667</td>
      <td>0.0</td>
      <td>0.416667</td>
      <td>17.216667</td>
      <td>0.999422</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_sequences</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates sequences from time series data for LSTM/GRU model input.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    data : numpy array</span>
<span class="sd">        Input data with shape (samples, features).</span>
<span class="sd">        The last column is assumed to be the target variable.</span>
<span class="sd">    n_steps : int</span>
<span class="sd">        Number of time steps to look back (sequence length)</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    X : numpy array</span>
<span class="sd">        Sequences with shape (samples, timesteps, features)</span>
<span class="sd">    y : numpy array</span>
<span class="sd">        Target values with shape (samples,)</span>

<span class="sd">    Example:</span>
<span class="sd">    --------</span>
<span class="sd">    # Assuming &#39;data&#39; is your numpy array with shape (1000, 5)</span>
<span class="sd">    # where last column is your target variable</span>
<span class="sd">    X, y = create_sequences(data, n_steps=30)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_steps</span><span class="p">):</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:(</span><span class="n">i</span> <span class="o">+</span> <span class="n">n_steps</span><span class="p">),</span> <span class="p">:]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">n_steps</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Last column as target</span>
        <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
        <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span><span class="n">MinMaxScaler</span>
<span class="n">original_columns</span> <span class="o">=</span> <span class="n">df_hourly</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># Data preprocessing</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">df_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">df_scaled</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_scaled</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">df_scaled</span><span class="p">[</span><span class="s1">&#39;Datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span>
<span class="n">df_scaled</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Datetime&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_scaled</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>voltage</th>
      <th>global_intensity</th>
      <th>sub_metering_1</th>
      <th>sub_metering_2</th>
      <th>sub_metering_3</th>
      <th>power_factor</th>
    </tr>
    <tr>
      <th>Datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2006-12-16 17:00:00</th>
      <td>-2.077988</td>
      <td>3.607876</td>
      <td>-0.319086</td>
      <td>-0.184969</td>
      <td>1.424259</td>
      <td>0.811481</td>
    </tr>
    <tr>
      <th>2006-12-16 18:00:00</th>
      <td>-2.099360</td>
      <td>2.938368</td>
      <td>-0.319086</td>
      <td>1.300378</td>
      <td>1.425020</td>
      <td>0.872132</td>
    </tr>
    <tr>
      <th>2006-12-16 19:00:00</th>
      <td>-2.551344</td>
      <td>2.644677</td>
      <td>-0.319086</td>
      <td>0.032366</td>
      <td>1.399919</td>
      <td>0.872329</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Train-test split</span>
<span class="n">train_df</span> <span class="o">=</span> <span class="n">df_scaled</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_scaled</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="s1">&#39;2010-01-01 00:00:00&#39;</span><span class="p">]</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">df_scaled</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_scaled</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="s1">&#39;2010-01-01 00:00:00&#39;</span><span class="p">]</span>

<span class="n">target_col</span> <span class="o">=</span> <span class="s1">&#39;power_factor&#39;</span>
<span class="n">feature_cols</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">target_col</span><span class="p">])</span>

<span class="c1"># Prepare data for LSTM</span>
<span class="n">X_train_raw</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">y_train_raw</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">X_test_raw</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">y_test_raw</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_scaled</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>voltage</th>
      <th>global_intensity</th>
      <th>sub_metering_1</th>
      <th>sub_metering_2</th>
      <th>sub_metering_3</th>
      <th>power_factor</th>
    </tr>
    <tr>
      <th>Datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2006-12-16 17:00:00</th>
      <td>-2.077988</td>
      <td>3.607876</td>
      <td>-0.319086</td>
      <td>-0.184969</td>
      <td>1.424259</td>
      <td>0.811481</td>
    </tr>
    <tr>
      <th>2006-12-16 18:00:00</th>
      <td>-2.099360</td>
      <td>2.938368</td>
      <td>-0.319086</td>
      <td>1.300378</td>
      <td>1.425020</td>
      <td>0.872132</td>
    </tr>
    <tr>
      <th>2006-12-16 19:00:00</th>
      <td>-2.551344</td>
      <td>2.644677</td>
      <td>-0.319086</td>
      <td>0.032366</td>
      <td>1.399919</td>
      <td>0.872329</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>voltage</th>
      <th>global_intensity</th>
      <th>sub_metering_1</th>
      <th>sub_metering_2</th>
      <th>sub_metering_3</th>
      <th>power_factor</th>
    </tr>
    <tr>
      <th>Datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2006-12-16 17:00:00</th>
      <td>-2.077988</td>
      <td>3.607876</td>
      <td>-0.319086</td>
      <td>-0.184969</td>
      <td>1.424259</td>
      <td>0.811481</td>
    </tr>
    <tr>
      <th>2006-12-16 18:00:00</th>
      <td>-2.099360</td>
      <td>2.938368</td>
      <td>-0.319086</td>
      <td>1.300378</td>
      <td>1.425020</td>
      <td>0.872132</td>
    </tr>
    <tr>
      <th>2006-12-16 19:00:00</th>
      <td>-2.551344</td>
      <td>2.644677</td>
      <td>-0.319086</td>
      <td>0.032366</td>
      <td>1.399919</td>
      <td>0.872329</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>voltage</th>
      <th>global_intensity</th>
      <th>sub_metering_1</th>
      <th>sub_metering_2</th>
      <th>sub_metering_3</th>
      <th>power_factor</th>
    </tr>
    <tr>
      <th>Datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2009-12-31 21:00:00</th>
      <td>-1.408023</td>
      <td>2.001056</td>
      <td>-0.319086</td>
      <td>-0.227636</td>
      <td>1.678307</td>
      <td>0.805964</td>
    </tr>
    <tr>
      <th>2009-12-31 22:00:00</th>
      <td>-0.981304</td>
      <td>1.042320</td>
      <td>-0.319086</td>
      <td>-0.183636</td>
      <td>1.577905</td>
      <td>0.795738</td>
    </tr>
    <tr>
      <th>2009-12-31 23:00:00</th>
      <td>-0.257716</td>
      <td>0.623654</td>
      <td>-0.319086</td>
      <td>-0.311637</td>
      <td>1.623542</td>
      <td>0.809150</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>voltage</th>
      <th>global_intensity</th>
      <th>sub_metering_1</th>
      <th>sub_metering_2</th>
      <th>sub_metering_3</th>
      <th>power_factor</th>
    </tr>
    <tr>
      <th>Datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2010-01-01 00:00:00</th>
      <td>0.154358</td>
      <td>-0.040499</td>
      <td>-0.319086</td>
      <td>-0.311637</td>
      <td>0.281803</td>
      <td>0.628644</td>
    </tr>
    <tr>
      <th>2010-01-01 01:00:00</th>
      <td>0.261905</td>
      <td>-0.510047</td>
      <td>-0.319086</td>
      <td>-0.119635</td>
      <td>-0.795239</td>
      <td>0.188649</td>
    </tr>
    <tr>
      <th>2010-01-01 02:00:00</th>
      <td>1.064029</td>
      <td>-0.528794</td>
      <td>-0.319086</td>
      <td>-0.311637</td>
      <td>-0.792957</td>
      <td>0.429025</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_df</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>voltage</th>
      <th>global_intensity</th>
      <th>sub_metering_1</th>
      <th>sub_metering_2</th>
      <th>sub_metering_3</th>
      <th>power_factor</th>
    </tr>
    <tr>
      <th>Datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2010-11-26 19:00:00</th>
      <td>-1.374653</td>
      <td>0.650434</td>
      <td>-0.319086</td>
      <td>-0.295637</td>
      <td>-0.884232</td>
      <td>0.852165</td>
    </tr>
    <tr>
      <th>2010-11-26 20:00:00</th>
      <td>-0.484211</td>
      <td>0.076442</td>
      <td>-0.319086</td>
      <td>-0.055635</td>
      <td>-0.884232</td>
      <td>0.814536</td>
    </tr>
    <tr>
      <th>2010-11-26 21:00:00</th>
      <td>-0.385608</td>
      <td>-0.221712</td>
      <td>-0.319086</td>
      <td>-0.311637</td>
      <td>-0.884232</td>
      <td>0.883997</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="model-selection">
<h2><em><strong>3.2.Model Selection¶</strong></em><a class="headerlink" href="#model-selection" title="Link to this heading">#</a></h2>
<section id="lstm-long-short-term-memory">
<h3><em><strong>3.2.1.LSTM(Long Short Term Memory)</strong></em><a class="headerlink" href="#lstm-long-short-term-memory" title="Link to this heading">#</a></h3>
<p>LSTM (Long Short-Term Memory) is a special type of RNN (Recurrent Neural Network) designed for sequential data problems such as time series forecasting, natural language processing (NLP), and speech recognition.<br></p>
<p>Why LSTM?<br><br></p>
<ul class="simple">
<li><p>Can learn both short-term and long-term dependencies <br></p></li>
<li><p>Solves the Vanishing Gradient problem <br></p></li>
<li><p>Stores past information for a long time using memory cells <br><br>
Key Components of LSTM<br><br>
LSTM consists of three main gates:<br></p></li>
<li><p>Forget Gate: Deletes unnecessary information.<br></p></li>
<li><p>Input Gate: Adds new information to memory.<br></p></li>
<li><p>Output Gate: Outputs the updated information.<br><br>
Applications of LSTM<br><br></p></li>
<li><p>Time Series Forecasting (Finance, weather, energy demand prediction)<br></p></li>
<li><p>Natural Language Processing (NLP) (Text prediction, translation, chatbots)<br></p></li>
<li><p>Speech and Voice Recognition<br></p></li>
<li><p>Medical Data Analysis</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">tensorflow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.layers</span><span class="w"> </span><span class="kn">import</span> <span class="n">LSTM</span><span class="p">,</span> <span class="n">Bidirectional</span><span class="p">,</span> <span class="n">Dense</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.optimizers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.callbacks</span><span class="w"> </span><span class="kn">import</span> <span class="n">EarlyStopping</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_percentage_error</span>

<span class="c1"># Create sequences for LSTM</span>
<span class="n">n_steps</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">create_sequences</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">y_train_raw</span><span class="p">,</span> <span class="n">X_train_raw</span><span class="p">)),</span> <span class="n">n_steps</span><span class="p">)</span>
<span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">create_sequences</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">y_test_raw</span><span class="p">,</span> <span class="n">X_test_raw</span><span class="p">)),</span> <span class="n">n_steps</span><span class="p">)</span>

<span class="c1"># Create the LSTM model</span>
<span class="n">model_lstm</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
<span class="n">model_lstm</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span>
                   <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                   <span class="n">return_sequences</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">model_lstm</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># Compile the model</span>
<span class="n">model_lstm</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span>
                  <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mean_squared_error&quot;</span><span class="p">,</span>
                  <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean_absolute_error&#39;</span><span class="p">])</span>

<span class="c1"># Define early stopping callback</span>
<span class="n">early_stopping</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>
                             <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                             <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Train the model</span>
<span class="n">history_lstm</span> <span class="o">=</span> <span class="n">model_lstm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">,</span>
    <span class="n">y_train</span><span class="p">,</span>
    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stopping</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Plot training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_lstm</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_lstm</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Make predictions</span>
<span class="n">yhat</span> <span class="o">=</span> <span class="n">model_lstm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Ensure the predicted values and test values have the same length</span>
<span class="n">yhat</span> <span class="o">=</span> <span class="n">yhat</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># Convert to 1D array</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># ** Fix the inverse transform issue **</span>

<span class="c1"># Create an empty array for inverse transformation</span>
<span class="n">dummy_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">yhat</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_columns</span><span class="p">)))</span>

<span class="c1"># Assign predicted values to the correct column index</span>
<span class="n">target_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">original_columns</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">target_col</span><span class="p">)</span>
<span class="n">dummy_data</span><span class="p">[:,</span> <span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat</span>

<span class="c1"># Inverse transform using the original scaler</span>
<span class="n">inv_yhat</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)[:,</span> <span class="n">target_index</span><span class="p">]</span>

<span class="c1"># Do the same for actual values</span>
<span class="n">dummy_data</span><span class="p">[:,</span> <span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test</span>
<span class="n">inv_y</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)[:,</span> <span class="n">target_index</span><span class="p">]</span>

<span class="c1"># Check for shape consistency before computing metrics</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inv_y shape:&quot;</span><span class="p">,</span> <span class="n">inv_y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inv_yhat shape:&quot;</span><span class="p">,</span> <span class="n">inv_yhat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Calculate metrics</span>
<span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">inv_y</span><span class="p">,</span> <span class="n">inv_yhat</span><span class="p">))</span>
<span class="n">mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">inv_y</span> <span class="o">-</span> <span class="n">inv_yhat</span><span class="p">)</span> <span class="o">/</span> <span class="n">inv_y</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test MAPE: </span><span class="si">%.3f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test RMSE: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rmse</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/10
417/417 - 5s - 11ms/step - loss: 0.5721 - mean_absolute_error: 0.5992 - val_loss: 0.5413 - val_mean_absolute_error: 0.5742
Epoch 2/10
417/417 - 2s - 4ms/step - loss: 0.4818 - mean_absolute_error: 0.5255 - val_loss: 0.5093 - val_mean_absolute_error: 0.5265
Epoch 3/10
417/417 - 2s - 4ms/step - loss: 0.4638 - mean_absolute_error: 0.5073 - val_loss: 0.4934 - val_mean_absolute_error: 0.5058
Epoch 4/10
417/417 - 2s - 4ms/step - loss: 0.4521 - mean_absolute_error: 0.4969 - val_loss: 0.4790 - val_mean_absolute_error: 0.4993
Epoch 5/10
417/417 - 2s - 4ms/step - loss: 0.4419 - mean_absolute_error: 0.4893 - val_loss: 0.4717 - val_mean_absolute_error: 0.4956
Epoch 6/10
417/417 - 2s - 4ms/step - loss: 0.4318 - mean_absolute_error: 0.4805 - val_loss: 0.4670 - val_mean_absolute_error: 0.4961
Epoch 7/10
417/417 - 2s - 5ms/step - loss: 0.4245 - mean_absolute_error: 0.4748 - val_loss: 0.4561 - val_mean_absolute_error: 0.4887
Epoch 8/10
417/417 - 2s - 4ms/step - loss: 0.4150 - mean_absolute_error: 0.4664 - val_loss: 0.4516 - val_mean_absolute_error: 0.4873
Epoch 9/10
417/417 - 2s - 4ms/step - loss: 0.4072 - mean_absolute_error: 0.4589 - val_loss: 0.4441 - val_mean_absolute_error: 0.4846
Epoch 10/10
417/417 - 2s - 4ms/step - loss: 0.3992 - mean_absolute_error: 0.4523 - val_loss: 0.4452 - val_mean_absolute_error: 0.4888
</pre></div>
</div>
<img alt="../_images/26a39d5f9e96318abb4b4ef586e9b51d5c4b554e70fa6c972e718207f6aa3ea8.png" src="../_images/26a39d5f9e96318abb4b4ef586e9b51d5c4b554e70fa6c972e718207f6aa3ea8.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">247/247</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">1s</span> 2ms/step
inv_y shape: (7888,)
inv_yhat shape: (7888,)
Test MAPE: 2.013%
Test RMSE: 0.027
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plotting the results</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">inv_y</span><span class="p">):],</span> <span class="n">inv_y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">inv_y</span><span class="p">):],</span> <span class="n">inv_yhat</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predictions&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Power Factor&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Power Factor Predictions vs True Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ef68c0ab2aa576c0d09018b926cf05100c9783465cfc25e310bf537c5ad6d892.png" src="../_images/ef68c0ab2aa576c0d09018b926cf05100c9783465cfc25e310bf537c5ad6d892.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_lstm</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">Model: "sequential"</span>
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> Layer (type)                         </span>┃<span style="font-weight: bold"> Output Shape                </span>┃<span style="font-weight: bold">         Param # </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━┩
│ lstm (<span style="color: #0087ff; text-decoration-color: #0087ff">LSTM</span>)                          │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">100</span>)                 │          <span style="color: #00af00; text-decoration-color: #00af00">42,800</span> │
├──────────────────────────────────────┼─────────────────────────────┼─────────────────┤
│ dense (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                        │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>)                   │             <span style="color: #00af00; text-decoration-color: #00af00">101</span> │
└──────────────────────────────────────┴─────────────────────────────┴─────────────────┘
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Total params: </span><span style="color: #00af00; text-decoration-color: #00af00">128,705</span> (502.76 KB)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">42,901</span> (167.58 KB)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Non-trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">0</span> (0.00 B)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Optimizer params: </span><span style="color: #00af00; text-decoration-color: #00af00">85,804</span> (335.18 KB)
</pre>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.layers</span><span class="w"> </span><span class="kn">import</span> <span class="n">LSTM</span><span class="p">,</span> <span class="n">Bidirectional</span><span class="p">,</span> <span class="n">Dense</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.optimizers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>

<span class="c1"># Create sequences for LSTM</span>
<span class="n">n_steps</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">create_sequences</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">y_train_raw</span><span class="p">,</span> <span class="n">X_train_raw</span><span class="p">)),</span> <span class="n">n_steps</span><span class="p">)</span>
<span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">create_sequences</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">y_test_raw</span><span class="p">,</span> <span class="n">X_test_raw</span><span class="p">)),</span> <span class="n">n_steps</span><span class="p">)</span>

<span class="c1"># Create the LSTM model</span>
<span class="n">model_lstm</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
<span class="n">model_lstm</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span>
                   <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                   <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">model_lstm</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span>
                   <span class="n">return_sequences</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">model_lstm</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># Compile the model</span>
<span class="n">model_lstm</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.005</span><span class="p">),</span>
                  <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mean_squared_error&quot;</span><span class="p">,</span>
                  <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean_absolute_error&#39;</span><span class="p">])</span>

<span class="c1"># Define early stopping callback</span>
<span class="n">early_stopping</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>
                             <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                             <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Train the model</span>
<span class="n">history_lstm</span> <span class="o">=</span> <span class="n">model_lstm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">,</span>
    <span class="n">y_train</span><span class="p">,</span>
    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stopping</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Plot training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_lstm</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_lstm</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Make predictions</span>
<span class="n">yhat</span> <span class="o">=</span> <span class="n">model_lstm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Ensure the predicted values and test values have the same length</span>
<span class="n">yhat</span> <span class="o">=</span> <span class="n">yhat</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># Convert to 1D array</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># ** Fix the inverse transform issue **</span>

<span class="c1"># Create an empty array for inverse transformation</span>
<span class="n">dummy_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">yhat</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_columns</span><span class="p">)))</span>

<span class="c1"># Assign predicted values to the correct column index</span>
<span class="n">target_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">original_columns</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">target_col</span><span class="p">)</span>
<span class="n">dummy_data</span><span class="p">[:,</span> <span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat</span>

<span class="c1"># Inverse transform using the original scaler</span>
<span class="n">inv_yhat</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)[:,</span> <span class="n">target_index</span><span class="p">]</span>

<span class="c1"># Do the same for actual values</span>
<span class="n">dummy_data</span><span class="p">[:,</span> <span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test</span>
<span class="n">inv_y</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)[:,</span> <span class="n">target_index</span><span class="p">]</span>

<span class="c1"># Check for shape consistency before computing metrics</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inv_y shape:&quot;</span><span class="p">,</span> <span class="n">inv_y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inv_yhat shape:&quot;</span><span class="p">,</span> <span class="n">inv_yhat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Calculate metrics</span>
<span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">inv_y</span><span class="p">,</span> <span class="n">inv_yhat</span><span class="p">))</span>
<span class="n">mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">inv_y</span> <span class="o">-</span> <span class="n">inv_yhat</span><span class="p">)</span> <span class="o">/</span> <span class="n">inv_y</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test MAPE: </span><span class="si">%.3f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test RMSE: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rmse</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
833/833 - 6s - 8ms/step - loss: 0.5131 - mean_absolute_error: 0.5439 - val_loss: 0.5265 - val_mean_absolute_error: 0.5113
Epoch 2/20
833/833 - 5s - 6ms/step - loss: 0.4476 - mean_absolute_error: 0.4907 - val_loss: 0.4924 - val_mean_absolute_error: 0.4918
Epoch 3/20
833/833 - 5s - 6ms/step - loss: 0.4189 - mean_absolute_error: 0.4656 - val_loss: 0.4577 - val_mean_absolute_error: 0.4641
Epoch 4/20
833/833 - 5s - 6ms/step - loss: 0.3910 - mean_absolute_error: 0.4405 - val_loss: 0.4447 - val_mean_absolute_error: 0.4620
Epoch 5/20
833/833 - 5s - 6ms/step - loss: 0.3687 - mean_absolute_error: 0.4214 - val_loss: 0.4404 - val_mean_absolute_error: 0.4644
Epoch 6/20
833/833 - 5s - 6ms/step - loss: 0.3549 - mean_absolute_error: 0.4112 - val_loss: 0.4291 - val_mean_absolute_error: 0.4513
Epoch 7/20
833/833 - 5s - 5ms/step - loss: 0.3409 - mean_absolute_error: 0.3990 - val_loss: 0.4189 - val_mean_absolute_error: 0.4384
Epoch 8/20
833/833 - 5s - 6ms/step - loss: 0.3303 - mean_absolute_error: 0.3897 - val_loss: 0.4119 - val_mean_absolute_error: 0.4489
Epoch 9/20
833/833 - 5s - 6ms/step - loss: 0.3177 - mean_absolute_error: 0.3802 - val_loss: 0.4062 - val_mean_absolute_error: 0.4242
Epoch 10/20
833/833 - 5s - 6ms/step - loss: 0.3069 - mean_absolute_error: 0.3728 - val_loss: 0.4140 - val_mean_absolute_error: 0.4225
Epoch 11/20
833/833 - 5s - 5ms/step - loss: 0.2966 - mean_absolute_error: 0.3635 - val_loss: 0.4106 - val_mean_absolute_error: 0.4279
Epoch 12/20
833/833 - 5s - 6ms/step - loss: 0.2849 - mean_absolute_error: 0.3556 - val_loss: 0.4214 - val_mean_absolute_error: 0.4384
Epoch 13/20
833/833 - 5s - 6ms/step - loss: 0.2707 - mean_absolute_error: 0.3436 - val_loss: 0.4328 - val_mean_absolute_error: 0.4438
Epoch 14/20
833/833 - 5s - 6ms/step - loss: 0.2586 - mean_absolute_error: 0.3346 - val_loss: 0.4326 - val_mean_absolute_error: 0.4278
Epoch 15/20
833/833 - 5s - 6ms/step - loss: 0.2428 - mean_absolute_error: 0.3235 - val_loss: 0.4380 - val_mean_absolute_error: 0.4372
Epoch 16/20
833/833 - 5s - 6ms/step - loss: 0.2387 - mean_absolute_error: 0.3188 - val_loss: 0.4520 - val_mean_absolute_error: 0.4472
Epoch 17/20
833/833 - 5s - 6ms/step - loss: 0.2275 - mean_absolute_error: 0.3124 - val_loss: 0.4611 - val_mean_absolute_error: 0.4502
Epoch 18/20
833/833 - 5s - 6ms/step - loss: 0.2168 - mean_absolute_error: 0.3031 - val_loss: 0.4605 - val_mean_absolute_error: 0.4383
Epoch 19/20
833/833 - 5s - 6ms/step - loss: 0.2100 - mean_absolute_error: 0.2987 - val_loss: 0.4806 - val_mean_absolute_error: 0.4441
</pre></div>
</div>
<img alt="../_images/e04d883b53fdd90733d330ed547cb3e5ccb6c97c0599038f1e91e4f672f6cb44.png" src="../_images/e04d883b53fdd90733d330ed547cb3e5ccb6c97c0599038f1e91e4f672f6cb44.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">247/247</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">1s</span> 2ms/step
inv_y shape: (7894,)
inv_yhat shape: (7894,)
Test MAPE: 1.776%
Test RMSE: 0.026
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plotting the results</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">inv_y</span><span class="p">):],</span> <span class="n">inv_y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">inv_y</span><span class="p">):],</span> <span class="n">inv_yhat</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predictions&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Power Factor&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Power Factor Predictions vs True Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/00e66209056fa129fbda7e4e11157e0acd457347c141bd644096f08bd5a51712.png" src="../_images/00e66209056fa129fbda7e4e11157e0acd457347c141bd644096f08bd5a51712.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.layers</span><span class="w"> </span><span class="kn">import</span> <span class="n">LSTM</span><span class="p">,</span> <span class="n">Bidirectional</span><span class="p">,</span> <span class="n">Dense</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.optimizers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>
<span class="c1"># Create sequences for LSTM</span>
<span class="n">n_steps</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">create_sequences</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">y_train_raw</span><span class="p">,</span> <span class="n">X_train_raw</span><span class="p">)),</span> <span class="n">n_steps</span><span class="p">)</span>
<span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">create_sequences</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">y_test_raw</span><span class="p">,</span> <span class="n">X_test_raw</span><span class="p">)),</span> <span class="n">n_steps</span><span class="p">)</span>

<span class="c1"># Create the LSTM model</span>
<span class="n">model_lstm</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
<span class="n">model_lstm</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span>
                   <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                   <span class="n">return_sequences</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">model_lstm</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># Compile the model</span>
<span class="n">model_lstm</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span>
                  <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mean_squared_error&quot;</span><span class="p">,</span>
                  <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean_absolute_error&#39;</span><span class="p">])</span>

<span class="c1"># Define early stopping callback</span>
<span class="n">early_stopping</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>
                             <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                             <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Train the model</span>
<span class="n">history_lstm</span> <span class="o">=</span> <span class="n">model_lstm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">,</span>
    <span class="n">y_train</span><span class="p">,</span>
    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stopping</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Plot training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_lstm</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_lstm</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Make predictions</span>
<span class="n">yhat</span> <span class="o">=</span> <span class="n">model_lstm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Ensure the predicted values and test values have the same length</span>
<span class="n">yhat</span> <span class="o">=</span> <span class="n">yhat</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># Convert to 1D array</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># ** Fix the inverse transform issue **</span>

<span class="c1"># Create an empty array for inverse transformation</span>
<span class="n">dummy_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">yhat</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_columns</span><span class="p">)))</span>

<span class="c1"># Assign predicted values to the correct column index</span>
<span class="n">target_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">original_columns</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">target_col</span><span class="p">)</span>
<span class="n">dummy_data</span><span class="p">[:,</span> <span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat</span>

<span class="c1"># Inverse transform using the original scaler</span>
<span class="n">inv_yhat</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)[:,</span> <span class="n">target_index</span><span class="p">]</span>

<span class="c1"># Do the same for actual values</span>
<span class="n">dummy_data</span><span class="p">[:,</span> <span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test</span>
<span class="n">inv_y</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)[:,</span> <span class="n">target_index</span><span class="p">]</span>

<span class="c1"># Check for shape consistency before computing metrics</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inv_y shape:&quot;</span><span class="p">,</span> <span class="n">inv_y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inv_yhat shape:&quot;</span><span class="p">,</span> <span class="n">inv_yhat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Calculate metrics</span>
<span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">inv_y</span><span class="p">,</span> <span class="n">inv_yhat</span><span class="p">))</span>
<span class="n">mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">inv_y</span> <span class="o">-</span> <span class="n">inv_yhat</span><span class="p">)</span> <span class="o">/</span> <span class="n">inv_y</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test MAPE: </span><span class="si">%.3f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test RMSE: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rmse</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/10
417/417 - 3s - 7ms/step - loss: 0.5636 - mean_absolute_error: 0.5940 - val_loss: 0.5406 - val_mean_absolute_error: 0.5675
Epoch 2/10
417/417 - 2s - 4ms/step - loss: 0.4814 - mean_absolute_error: 0.5251 - val_loss: 0.5041 - val_mean_absolute_error: 0.5208
Epoch 3/10
417/417 - 2s - 4ms/step - loss: 0.4619 - mean_absolute_error: 0.5060 - val_loss: 0.4856 - val_mean_absolute_error: 0.5041
Epoch 4/10
417/417 - 2s - 4ms/step - loss: 0.4506 - mean_absolute_error: 0.4959 - val_loss: 0.4781 - val_mean_absolute_error: 0.4963
Epoch 5/10
417/417 - 2s - 4ms/step - loss: 0.4399 - mean_absolute_error: 0.4873 - val_loss: 0.4741 - val_mean_absolute_error: 0.4962
Epoch 6/10
417/417 - 2s - 4ms/step - loss: 0.4300 - mean_absolute_error: 0.4798 - val_loss: 0.4680 - val_mean_absolute_error: 0.4958
Epoch 7/10
417/417 - 2s - 4ms/step - loss: 0.4221 - mean_absolute_error: 0.4731 - val_loss: 0.4622 - val_mean_absolute_error: 0.4929
Epoch 8/10
417/417 - 2s - 4ms/step - loss: 0.4144 - mean_absolute_error: 0.4667 - val_loss: 0.4537 - val_mean_absolute_error: 0.4879
Epoch 9/10
417/417 - 2s - 4ms/step - loss: 0.4076 - mean_absolute_error: 0.4603 - val_loss: 0.4567 - val_mean_absolute_error: 0.4922
Epoch 10/10
417/417 - 2s - 4ms/step - loss: 0.3991 - mean_absolute_error: 0.4530 - val_loss: 0.4517 - val_mean_absolute_error: 0.4893
</pre></div>
</div>
<img alt="../_images/933140edb0cead2076bee0f1a9f7a5007324ac0ff1edb9717191a98abcc9cb80.png" src="../_images/933140edb0cead2076bee0f1a9f7a5007324ac0ff1edb9717191a98abcc9cb80.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">247/247</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">1s</span> 2ms/step
inv_y shape: (7888,)
inv_yhat shape: (7888,)
Test MAPE: 2.034%
Test RMSE: 0.027
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a DataFrame containing actual and predicted values</span>
<span class="n">diff</span> <span class="o">=</span> <span class="n">inv_y</span><span class="o">-</span><span class="n">inv_yhat</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Datetime&#39;</span><span class="p">:</span> <span class="n">test_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">n_steps</span><span class="p">:],</span>
    <span class="s1">&#39;Actual&#39;</span><span class="p">:</span> <span class="n">inv_y</span><span class="p">,</span>
    <span class="s1">&#39;Predicted&#39;</span><span class="p">:</span> <span class="n">inv_yhat</span><span class="p">,</span>
    <span class="s1">&#39;Error&#39;</span> <span class="p">:</span> <span class="n">diff</span>
<span class="p">})</span>


<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                Datetime    Actual  Predicted     Error
2668 2010-04-23 10:00:00  1.027931   0.999802  0.028129
4203 2010-06-26 09:00:00  0.974499   0.962945  0.011553
2539 2010-04-18 01:00:00  0.933867   0.954150 -0.020283
2208 2010-04-04 06:00:00  0.931919   0.938832 -0.006913
4808 2010-07-21 14:00:00  0.937578   0.953672 -0.016094
5136 2010-08-04 06:00:00  0.937300   0.931145  0.006155
2620 2010-04-21 10:00:00  1.036558   0.963703  0.072855
7576 2010-11-13 22:00:00  1.024035   1.005367  0.018668
6512 2010-09-30 14:00:00  0.931734   0.942658 -0.010924
6731 2010-10-09 17:00:00  0.964944   1.006733 -0.041789
841  2010-02-06 07:00:00  1.034146   1.014141  0.020005
5923 2010-09-06 01:00:00  0.937207   0.937367 -0.000160
3494 2010-05-27 20:00:00  0.992959   0.976960  0.015998
6422 2010-09-26 20:00:00  0.964063   0.956612  0.007451
6849 2010-10-14 15:00:00  0.966150   1.005592 -0.039442
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;Datetime&#39;</span><span class="p">],</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;Actual&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Real_Values&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;Datetime&#39;</span><span class="p">],</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;Predicted&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predicted_Values&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Power Factor&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Real vs Predicted Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c5b9ba6b946e606e860372f734b9401b118183741b8e06101268daac5871858a.png" src="../_images/c5b9ba6b946e606e860372f734b9401b118183741b8e06101268daac5871858a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plotting the results</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">inv_y</span><span class="p">):],</span> <span class="n">inv_y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">inv_y</span><span class="p">):],</span> <span class="n">inv_yhat</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predictions&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Power Factor&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Power Factor Predictions vs True Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ebb00a4f24a010c212f14ce76004428430f6753ecf50b14ac9d48607acfe9090.png" src="../_images/ebb00a4f24a010c212f14ce76004428430f6753ecf50b14ac9d48607acfe9090.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_lstm</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">Model: "sequential_2"</span>
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> Layer (type)                         </span>┃<span style="font-weight: bold"> Output Shape                </span>┃<span style="font-weight: bold">         Param # </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━┩
│ lstm_3 (<span style="color: #0087ff; text-decoration-color: #0087ff">LSTM</span>)                        │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">100</span>)                 │          <span style="color: #00af00; text-decoration-color: #00af00">42,800</span> │
├──────────────────────────────────────┼─────────────────────────────┼─────────────────┤
│ dense_2 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                      │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>)                   │             <span style="color: #00af00; text-decoration-color: #00af00">101</span> │
└──────────────────────────────────────┴─────────────────────────────┴─────────────────┘
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Total params: </span><span style="color: #00af00; text-decoration-color: #00af00">128,705</span> (502.76 KB)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">42,901</span> (167.58 KB)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Non-trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">0</span> (0.00 B)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Optimizer params: </span><span style="color: #00af00; text-decoration-color: #00af00">85,804</span> (335.18 KB)
</pre>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.layers</span><span class="w"> </span><span class="kn">import</span> <span class="n">LSTM</span><span class="p">,</span> <span class="n">Bidirectional</span><span class="p">,</span> <span class="n">Dense</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.optimizers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>

<span class="c1"># Create sequences for LSTM</span>
<span class="n">n_steps</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">create_sequences</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">y_train_raw</span><span class="p">,</span> <span class="n">X_train_raw</span><span class="p">)),</span> <span class="n">n_steps</span><span class="p">)</span>
<span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">create_sequences</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">y_test_raw</span><span class="p">,</span> <span class="n">X_test_raw</span><span class="p">)),</span> <span class="n">n_steps</span><span class="p">)</span>

<span class="c1"># Create the LSTM model</span>
<span class="n">model_bilstm</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
<span class="n">model_bilstm</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Bidirectional</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span>
                   <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                   <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
<span class="n">model_bilstm</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Bidirectional</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span>
                   <span class="n">return_sequences</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>
<span class="n">model_bilstm</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># Compile the model</span>
<span class="n">model_bilstm</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.005</span><span class="p">),</span>
                  <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mean_squared_error&quot;</span><span class="p">,</span>
                  <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean_absolute_error&#39;</span><span class="p">])</span>

<span class="c1"># Define early stopping callback</span>
<span class="n">early_stopping</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>
                             <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                             <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Train the model</span>
<span class="n">history_bilstm</span> <span class="o">=</span> <span class="n">model_bilstm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">,</span>
    <span class="n">y_train</span><span class="p">,</span>
    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stopping</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Plot training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_bilstm</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_bilstm</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Make predictions</span>
<span class="n">yhat</span> <span class="o">=</span> <span class="n">model_bilstm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Ensure the predicted values and test values have the same length</span>
<span class="n">yhat</span> <span class="o">=</span> <span class="n">yhat</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># Convert to 1D array</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># ** Fix the inverse transform issue **</span>

<span class="c1"># Create an empty array for inverse transformation</span>
<span class="n">dummy_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">yhat</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_columns</span><span class="p">)))</span>

<span class="c1"># Assign predicted values to the correct column index</span>
<span class="n">target_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">original_columns</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">target_col</span><span class="p">)</span>
<span class="n">dummy_data</span><span class="p">[:,</span> <span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat</span>

<span class="c1"># Inverse transform using the original scaler</span>
<span class="n">inv_yhat</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)[:,</span> <span class="n">target_index</span><span class="p">]</span>

<span class="c1"># Do the same for actual values</span>
<span class="n">dummy_data</span><span class="p">[:,</span> <span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test</span>
<span class="n">inv_y</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)[:,</span> <span class="n">target_index</span><span class="p">]</span>

<span class="c1"># Check for shape consistency before computing metrics</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inv_y shape:&quot;</span><span class="p">,</span> <span class="n">inv_y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inv_yhat shape:&quot;</span><span class="p">,</span> <span class="n">inv_yhat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Calculate metrics</span>
<span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">inv_y</span><span class="p">,</span> <span class="n">inv_yhat</span><span class="p">))</span>
<span class="n">mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">inv_y</span> <span class="o">-</span> <span class="n">inv_yhat</span><span class="p">)</span> <span class="o">/</span> <span class="n">inv_y</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test MAPE: </span><span class="si">%.3f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test RMSE: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rmse</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
1666/1666 - 19s - 11ms/step - loss: 0.4920 - mean_absolute_error: 0.5252 - val_loss: 0.4869 - val_mean_absolute_error: 0.4921
Epoch 2/20
1666/1666 - 15s - 9ms/step - loss: 0.4311 - mean_absolute_error: 0.4754 - val_loss: 0.4626 - val_mean_absolute_error: 0.4795
Epoch 3/20
1666/1666 - 15s - 9ms/step - loss: 0.3963 - mean_absolute_error: 0.4460 - val_loss: 0.4615 - val_mean_absolute_error: 0.4568
Epoch 4/20
1666/1666 - 15s - 9ms/step - loss: 0.3779 - mean_absolute_error: 0.4301 - val_loss: 0.4555 - val_mean_absolute_error: 0.4594
Epoch 5/20
1666/1666 - 15s - 9ms/step - loss: 0.4161 - mean_absolute_error: 0.4620 - val_loss: 0.4538 - val_mean_absolute_error: 0.4819
Epoch 6/20
1666/1666 - 15s - 9ms/step - loss: 0.3744 - mean_absolute_error: 0.4279 - val_loss: 0.4405 - val_mean_absolute_error: 0.4624
Epoch 7/20
1666/1666 - 16s - 10ms/step - loss: 0.3596 - mean_absolute_error: 0.4148 - val_loss: 0.4883 - val_mean_absolute_error: 0.4947
Epoch 8/20
1666/1666 - 15s - 9ms/step - loss: 0.3561 - mean_absolute_error: 0.4095 - val_loss: 0.4489 - val_mean_absolute_error: 0.4539
Epoch 9/20
1666/1666 - 15s - 9ms/step - loss: 0.3496 - mean_absolute_error: 0.4050 - val_loss: 0.4189 - val_mean_absolute_error: 0.4272
Epoch 10/20
1666/1666 - 15s - 9ms/step - loss: 0.3348 - mean_absolute_error: 0.3928 - val_loss: 0.4446 - val_mean_absolute_error: 0.4485
Epoch 11/20
1666/1666 - 15s - 9ms/step - loss: 0.3282 - mean_absolute_error: 0.3892 - val_loss: 0.4323 - val_mean_absolute_error: 0.4309
Epoch 12/20
1666/1666 - 15s - 9ms/step - loss: 0.3179 - mean_absolute_error: 0.3802 - val_loss: 0.4630 - val_mean_absolute_error: 0.4592
Epoch 13/20
1666/1666 - 15s - 9ms/step - loss: 0.3092 - mean_absolute_error: 0.3736 - val_loss: 0.4445 - val_mean_absolute_error: 0.4407
Epoch 14/20
1666/1666 - 15s - 9ms/step - loss: 0.2954 - mean_absolute_error: 0.3638 - val_loss: 0.4246 - val_mean_absolute_error: 0.4331
Epoch 15/20
1666/1666 - 15s - 9ms/step - loss: 0.2876 - mean_absolute_error: 0.3593 - val_loss: 0.4334 - val_mean_absolute_error: 0.4283
Epoch 16/20
1666/1666 - 15s - 9ms/step - loss: 0.2798 - mean_absolute_error: 0.3531 - val_loss: 0.4606 - val_mean_absolute_error: 0.4513
Epoch 17/20
1666/1666 - 15s - 9ms/step - loss: 0.2778 - mean_absolute_error: 0.3523 - val_loss: 0.4404 - val_mean_absolute_error: 0.4345
Epoch 18/20
1666/1666 - 15s - 9ms/step - loss: 0.2642 - mean_absolute_error: 0.3432 - val_loss: 0.4419 - val_mean_absolute_error: 0.4350
Epoch 19/20
1666/1666 - 15s - 9ms/step - loss: 0.2567 - mean_absolute_error: 0.3376 - val_loss: 0.4420 - val_mean_absolute_error: 0.4329
</pre></div>
</div>
<img alt="../_images/0e86585e4a0014238f0c375802d5ee10f592ea4cbaa3c37b1a904653f6d84bd1.png" src="../_images/0e86585e4a0014238f0c375802d5ee10f592ea4cbaa3c37b1a904653f6d84bd1.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">247/247</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">1s</span> 4ms/step
inv_y shape: (7894,)
inv_yhat shape: (7894,)
Test MAPE: 1.792%
Test RMSE: 0.026
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_bilstm</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">Model: "sequential_3"</span>
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> Layer (type)                         </span>┃<span style="font-weight: bold"> Output Shape                </span>┃<span style="font-weight: bold">         Param # </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━┩
│ bidirectional (<span style="color: #0087ff; text-decoration-color: #0087ff">Bidirectional</span>)        │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">24</span>, <span style="color: #00af00; text-decoration-color: #00af00">256</span>)             │         <span style="color: #00af00; text-decoration-color: #00af00">138,240</span> │
├──────────────────────────────────────┼─────────────────────────────┼─────────────────┤
│ bidirectional_1 (<span style="color: #0087ff; text-decoration-color: #0087ff">Bidirectional</span>)      │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">128</span>)                 │         <span style="color: #00af00; text-decoration-color: #00af00">164,352</span> │
├──────────────────────────────────────┼─────────────────────────────┼─────────────────┤
│ dense_3 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                      │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>)                   │             <span style="color: #00af00; text-decoration-color: #00af00">129</span> │
└──────────────────────────────────────┴─────────────────────────────┴─────────────────┘
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Total params: </span><span style="color: #00af00; text-decoration-color: #00af00">908,165</span> (3.46 MB)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">302,721</span> (1.15 MB)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Non-trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">0</span> (0.00 B)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Optimizer params: </span><span style="color: #00af00; text-decoration-color: #00af00">605,444</span> (2.31 MB)
</pre>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plotting the results</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">inv_y</span><span class="p">):],</span> <span class="n">inv_y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">inv_y</span><span class="p">):],</span> <span class="n">inv_yhat</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predictions&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Power Factor&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Power Factor Predictions vs True Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ccf0e077c7f142e3214437a4d6d9c5ef3b145e80b06c9748579795fc59e943ff.png" src="../_images/ccf0e077c7f142e3214437a4d6d9c5ef3b145e80b06c9748579795fc59e943ff.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a DataFrame containing actual and predicted values</span>
<span class="n">diff</span> <span class="o">=</span> <span class="n">inv_y</span><span class="o">-</span><span class="n">inv_yhat</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Datetime&#39;</span><span class="p">:</span> <span class="n">test_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">n_steps</span><span class="p">:],</span>
    <span class="s1">&#39;Actual&#39;</span><span class="p">:</span> <span class="n">inv_y</span><span class="p">,</span>
    <span class="s1">&#39;Predicted&#39;</span><span class="p">:</span> <span class="n">inv_yhat</span><span class="p">,</span>
    <span class="s1">&#39;Error&#39;</span> <span class="p">:</span> <span class="n">diff</span>
<span class="p">})</span>


<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                Datetime    Actual  Predicted     Error
6854 2010-10-14 14:00:00  1.016614   0.983237  0.033377
6804 2010-10-12 12:00:00  1.040547   0.959848  0.080699
1413 2010-03-01 21:00:00  0.931734   0.985160 -0.053426
5556 2010-08-21 12:00:00  0.964063   0.972673 -0.008610
6135 2010-09-14 15:00:00  0.937021   0.939932 -0.002911
6358 2010-09-23 22:00:00  0.937300   0.978097 -0.040797
1285 2010-02-24 13:00:00  1.032848   1.026820  0.006028
2401 2010-04-12 01:00:00  0.931827   0.939914 -0.008088
7206 2010-10-29 06:00:00  0.943515   0.925001  0.018514
709  2010-01-31 13:00:00  1.036651   0.959110  0.077541
3064 2010-05-09 16:00:00  0.944072   0.947471 -0.003400
2574 2010-04-19 06:00:00  0.999823   0.965437  0.034386
4990 2010-07-28 22:00:00  0.937578   0.931329  0.006249
4572 2010-07-11 12:00:00  0.952791   1.030829 -0.078038
3450 2010-05-25 18:00:00  0.938042   0.955401 -0.017359
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="the-results-don-t-look-bad-but">
<h2><strong>The results don’t look bad but</strong><br><a class="headerlink" href="#the-results-don-t-look-bad-but" title="Link to this heading">#</a></h2>
<p>In the loss graph, the blue line shows training loss, while the orange line shows test loss.
Loss values start at approximately 0.46 and decrease to around 0.025 over time, indicating that the model is learning.
There are several possible reasons for the fluctuating test loss:</p>
<ul class="simple">
<li><p>Noise in the dataset</p></li>
<li><p>Learning rate might be a bit high</p></li>
<li><p>Small batch size</p></li>
<li><p>Model’s tendency to overfit in some periods</p></li>
</ul>
<p>Prediction vs True Values Graph Analysis:</p>
<ul class="simple">
<li><p>The blue line shows actual power factor values, while orange dots represent prediction.Predictions generally track the true values quite well (in the 0.95-1.00 range). More deviation is observed particularly during the 2010-07 and 2010-08 periods
The model can’t fully capture sudden drops (spikes), which is normal as predicting such sudden changes is difficult</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.layers</span><span class="w"> </span><span class="kn">import</span> <span class="n">LSTM</span><span class="p">,</span> <span class="n">Bidirectional</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span><span class="n">Dropout</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.optimizers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>

<span class="c1"># Create sequences for LSTM</span>
<span class="n">n_steps</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">create_sequences</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">y_train_raw</span><span class="p">,</span> <span class="n">X_train_raw</span><span class="p">)),</span> <span class="n">n_steps</span><span class="p">)</span>
<span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">create_sequences</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">y_test_raw</span><span class="p">,</span> <span class="n">X_test_raw</span><span class="p">)),</span> <span class="n">n_steps</span><span class="p">)</span>

<span class="c1"># Create the LSTM model</span>
<span class="n">model_bilstm</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
<span class="n">model_bilstm</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Bidirectional</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span>
                   <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                   <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
<span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">model_bilstm</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Bidirectional</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span>
                   <span class="n">return_sequences</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>
<span class="n">model_bilstm</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># Compile the model</span>
<span class="n">model_bilstm</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.003</span><span class="p">),</span>
                  <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mean_squared_error&quot;</span><span class="p">,</span>
                  <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean_absolute_error&#39;</span><span class="p">])</span>

<span class="c1"># Define early stopping callback</span>
<span class="n">early_stopping</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>
                             <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                             <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Train the model</span>
<span class="n">history_bilstm</span> <span class="o">=</span> <span class="n">model_bilstm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">,</span>
    <span class="n">y_train</span><span class="p">,</span>
    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stopping</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Plot training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_bilstm</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_bilstm</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Make predictions</span>
<span class="n">yhat</span> <span class="o">=</span> <span class="n">model_bilstm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Ensure the predicted values and test values have the same length</span>
<span class="n">yhat</span> <span class="o">=</span> <span class="n">yhat</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># Convert to 1D array</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># ** Fix the inverse transform issue **</span>

<span class="c1"># Create an empty array for inverse transformation</span>
<span class="n">dummy_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">yhat</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_columns</span><span class="p">)))</span>

<span class="c1"># Assign predicted values to the correct column index</span>
<span class="n">target_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">original_columns</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">target_col</span><span class="p">)</span>
<span class="n">dummy_data</span><span class="p">[:,</span> <span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat</span>

<span class="c1"># Inverse transform using the original scaler</span>
<span class="n">inv_yhat</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)[:,</span> <span class="n">target_index</span><span class="p">]</span>

<span class="c1"># Do the same for actual values</span>
<span class="n">dummy_data</span><span class="p">[:,</span> <span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test</span>
<span class="n">inv_y</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)[:,</span> <span class="n">target_index</span><span class="p">]</span>

<span class="c1"># Check for shape consistency before computing metrics</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inv_y shape:&quot;</span><span class="p">,</span> <span class="n">inv_y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inv_yhat shape:&quot;</span><span class="p">,</span> <span class="n">inv_yhat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Calculate metrics</span>
<span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">inv_y</span><span class="p">,</span> <span class="n">inv_yhat</span><span class="p">))</span>
<span class="n">mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">inv_y</span> <span class="o">-</span> <span class="n">inv_yhat</span><span class="p">)</span> <span class="o">/</span> <span class="n">inv_y</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test MAPE: </span><span class="si">%.3f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test RMSE: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rmse</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
417/417 - 7s - 17ms/step - loss: 0.5304 - mean_absolute_error: 0.5581 - val_loss: 0.5581 - val_mean_absolute_error: 0.5578
Epoch 2/20
417/417 - 4s - 9ms/step - loss: 0.4617 - mean_absolute_error: 0.5043 - val_loss: 0.5306 - val_mean_absolute_error: 0.5245
Epoch 3/20
417/417 - 4s - 9ms/step - loss: 0.4335 - mean_absolute_error: 0.4791 - val_loss: 0.4673 - val_mean_absolute_error: 0.4770
Epoch 4/20
417/417 - 4s - 9ms/step - loss: 0.4061 - mean_absolute_error: 0.4559 - val_loss: 0.4505 - val_mean_absolute_error: 0.4564
Epoch 5/20
417/417 - 4s - 9ms/step - loss: 0.3888 - mean_absolute_error: 0.4409 - val_loss: 0.4426 - val_mean_absolute_error: 0.4533
Epoch 6/20
417/417 - 4s - 10ms/step - loss: 0.3748 - mean_absolute_error: 0.4310 - val_loss: 0.4281 - val_mean_absolute_error: 0.4518
Epoch 7/20
417/417 - 4s - 9ms/step - loss: 0.3607 - mean_absolute_error: 0.4196 - val_loss: 0.4108 - val_mean_absolute_error: 0.4479
Epoch 8/20
417/417 - 4s - 9ms/step - loss: 0.3452 - mean_absolute_error: 0.4064 - val_loss: 0.4006 - val_mean_absolute_error: 0.4438
Epoch 9/20
417/417 - 4s - 9ms/step - loss: 0.3359 - mean_absolute_error: 0.3993 - val_loss: 0.4330 - val_mean_absolute_error: 0.4578
Epoch 10/20
417/417 - 4s - 9ms/step - loss: 0.3237 - mean_absolute_error: 0.3909 - val_loss: 0.4295 - val_mean_absolute_error: 0.4527
Epoch 11/20
417/417 - 4s - 9ms/step - loss: 0.3069 - mean_absolute_error: 0.3770 - val_loss: 0.4410 - val_mean_absolute_error: 0.4613
Epoch 12/20
417/417 - 4s - 9ms/step - loss: 0.2992 - mean_absolute_error: 0.3714 - val_loss: 0.4316 - val_mean_absolute_error: 0.4693
Epoch 13/20
417/417 - 4s - 9ms/step - loss: 0.2857 - mean_absolute_error: 0.3608 - val_loss: 0.4550 - val_mean_absolute_error: 0.4820
Epoch 14/20
417/417 - 4s - 10ms/step - loss: 0.2716 - mean_absolute_error: 0.3519 - val_loss: 0.4524 - val_mean_absolute_error: 0.4704
Epoch 15/20
417/417 - 4s - 9ms/step - loss: 0.2534 - mean_absolute_error: 0.3406 - val_loss: 0.4349 - val_mean_absolute_error: 0.4618
Epoch 16/20
417/417 - 4s - 9ms/step - loss: 0.2457 - mean_absolute_error: 0.3358 - val_loss: 0.4645 - val_mean_absolute_error: 0.4814
Epoch 17/20
417/417 - 4s - 9ms/step - loss: 0.2281 - mean_absolute_error: 0.3243 - val_loss: 0.4438 - val_mean_absolute_error: 0.4569
Epoch 18/20
417/417 - 4s - 9ms/step - loss: 0.2063 - mean_absolute_error: 0.3082 - val_loss: 0.4656 - val_mean_absolute_error: 0.4699
</pre></div>
</div>
<img alt="../_images/0ea897999e629da7618c15c8d77388dd7a3eb04a35f392f6617f3431f4cd2bb3.png" src="../_images/0ea897999e629da7618c15c8d77388dd7a3eb04a35f392f6617f3431f4cd2bb3.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">247/247</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">1s</span> 4ms/step
inv_y shape: (7894,)
inv_yhat shape: (7894,)
Test MAPE: 1.857%
Test RMSE: 0.026
</pre></div>
</div>
</div>
</div>
<section id="differecence-between-train-test-line-indicates-overfitting-so">
<h3><em><strong>Differecence between train-test line indicates overfitting, so</strong></em><a class="headerlink" href="#differecence-between-train-test-line-indicates-overfitting-so" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.layers</span><span class="w"> </span><span class="kn">import</span> <span class="n">LSTM</span><span class="p">,</span> <span class="n">Bidirectional</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span><span class="n">Dropout</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.optimizers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.regularizers</span><span class="w"> </span><span class="kn">import</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">l1_l2</span>

<span class="c1"># Create sequences for LSTM</span>
<span class="n">n_steps</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">create_sequences</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">y_train_raw</span><span class="p">,</span> <span class="n">X_train_raw</span><span class="p">)),</span> <span class="n">n_steps</span><span class="p">)</span>
<span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">create_sequences</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">y_test_raw</span><span class="p">,</span> <span class="n">X_test_raw</span><span class="p">)),</span> <span class="n">n_steps</span><span class="p">)</span>

<span class="c1"># Create the LSTM model</span>
<span class="n">model_bilstm</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
<span class="n">model_bilstm</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Bidirectional</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span>
                   <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                   <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>      <span class="c1"># to improve measures of over-fitting</span>
                   <span class="n">recurrent_regularizer</span><span class="o">=</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>   <span class="c1"># to improve measures of over-fitting</span>
                   <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
<span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">model_bilstm</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Bidirectional</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span>
                   <span class="n">return_sequences</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>
<span class="n">model_bilstm</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># Compile the model</span>
<span class="n">model_bilstm</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span>
                  <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mean_squared_error&quot;</span><span class="p">,</span>
                  <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mean_absolute_error&#39;</span><span class="p">])</span>

<span class="c1"># Define early stopping callback</span>
<span class="n">early_stopping</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>
                             <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                             <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Train the model</span>
<span class="n">history_bilstm</span> <span class="o">=</span> <span class="n">model_bilstm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">,</span>
    <span class="n">y_train</span><span class="p">,</span>
    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stopping</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Plot training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_bilstm</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_bilstm</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Make predictions</span>
<span class="n">yhat</span> <span class="o">=</span> <span class="n">model_bilstm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Ensure the predicted values and test values have the same length</span>
<span class="n">yhat</span> <span class="o">=</span> <span class="n">yhat</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># Convert to 1D array</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># ** Fix the inverse transform issue **</span>

<span class="c1"># Create an empty array for inverse transformation</span>
<span class="n">dummy_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">yhat</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_columns</span><span class="p">)))</span>

<span class="c1"># Assign predicted values to the correct column index</span>
<span class="n">target_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">original_columns</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">target_col</span><span class="p">)</span>
<span class="n">dummy_data</span><span class="p">[:,</span> <span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat</span>

<span class="c1"># Inverse transform using the original scaler</span>
<span class="n">inv_yhat</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)[:,</span> <span class="n">target_index</span><span class="p">]</span>

<span class="c1"># Do the same for actual values</span>
<span class="n">dummy_data</span><span class="p">[:,</span> <span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test</span>
<span class="n">inv_y</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)[:,</span> <span class="n">target_index</span><span class="p">]</span>

<span class="c1"># Check for shape consistency before computing metrics</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inv_y shape:&quot;</span><span class="p">,</span> <span class="n">inv_y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inv_yhat shape:&quot;</span><span class="p">,</span> <span class="n">inv_yhat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Calculate metrics</span>
<span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">inv_y</span><span class="p">,</span> <span class="n">inv_yhat</span><span class="p">))</span>
<span class="n">mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">inv_y</span> <span class="o">-</span> <span class="n">inv_yhat</span><span class="p">)</span> <span class="o">/</span> <span class="n">inv_y</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test MAPE: </span><span class="si">%.3f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test RMSE: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rmse</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
417/417 - 8s - 18ms/step - loss: 0.8395 - mean_absolute_error: 0.5947 - val_loss: 0.5771 - val_mean_absolute_error: 0.5634
Epoch 2/20
417/417 - 4s - 9ms/step - loss: 0.5202 - mean_absolute_error: 0.5377 - val_loss: 0.5415 - val_mean_absolute_error: 0.5388
Epoch 3/20
417/417 - 4s - 10ms/step - loss: 0.4972 - mean_absolute_error: 0.5217 - val_loss: 0.5331 - val_mean_absolute_error: 0.5268
Epoch 4/20
417/417 - 4s - 10ms/step - loss: 0.4818 - mean_absolute_error: 0.5074 - val_loss: 0.5205 - val_mean_absolute_error: 0.5207
Epoch 5/20
417/417 - 4s - 10ms/step - loss: 0.4701 - mean_absolute_error: 0.4981 - val_loss: 0.5197 - val_mean_absolute_error: 0.5161
Epoch 6/20
417/417 - 4s - 9ms/step - loss: 0.4621 - mean_absolute_error: 0.4906 - val_loss: 0.5085 - val_mean_absolute_error: 0.4966
Epoch 7/20
417/417 - 4s - 9ms/step - loss: 0.4531 - mean_absolute_error: 0.4827 - val_loss: 0.4929 - val_mean_absolute_error: 0.4806
Epoch 8/20
417/417 - 4s - 9ms/step - loss: 0.4471 - mean_absolute_error: 0.4777 - val_loss: 0.4905 - val_mean_absolute_error: 0.4739
Epoch 9/20
417/417 - 4s - 9ms/step - loss: 0.4372 - mean_absolute_error: 0.4699 - val_loss: 0.4828 - val_mean_absolute_error: 0.4723
Epoch 10/20
417/417 - 4s - 10ms/step - loss: 0.4289 - mean_absolute_error: 0.4632 - val_loss: 0.4720 - val_mean_absolute_error: 0.4633
Epoch 11/20
417/417 - 4s - 10ms/step - loss: 0.4216 - mean_absolute_error: 0.4574 - val_loss: 0.4670 - val_mean_absolute_error: 0.4616
Epoch 12/20
417/417 - 4s - 9ms/step - loss: 0.4146 - mean_absolute_error: 0.4517 - val_loss: 0.4622 - val_mean_absolute_error: 0.4612
Epoch 13/20
417/417 - 4s - 9ms/step - loss: 0.4063 - mean_absolute_error: 0.4455 - val_loss: 0.4517 - val_mean_absolute_error: 0.4593
Epoch 14/20
417/417 - 4s - 9ms/step - loss: 0.4115 - mean_absolute_error: 0.4485 - val_loss: 0.4467 - val_mean_absolute_error: 0.4624
Epoch 15/20
417/417 - 4s - 10ms/step - loss: 0.3978 - mean_absolute_error: 0.4389 - val_loss: 0.4364 - val_mean_absolute_error: 0.4554
Epoch 16/20
417/417 - 4s - 9ms/step - loss: 0.3887 - mean_absolute_error: 0.4330 - val_loss: 0.4416 - val_mean_absolute_error: 0.4536
Epoch 17/20
417/417 - 4s - 9ms/step - loss: 0.3826 - mean_absolute_error: 0.4278 - val_loss: 0.4439 - val_mean_absolute_error: 0.4620
Epoch 18/20
417/417 - 4s - 10ms/step - loss: 0.3786 - mean_absolute_error: 0.4250 - val_loss: 0.4529 - val_mean_absolute_error: 0.4721
Epoch 19/20
417/417 - 4s - 10ms/step - loss: 0.3759 - mean_absolute_error: 0.4238 - val_loss: 0.4490 - val_mean_absolute_error: 0.4727
Epoch 20/20
417/417 - 4s - 10ms/step - loss: 0.3716 - mean_absolute_error: 0.4204 - val_loss: 0.4505 - val_mean_absolute_error: 0.4701
</pre></div>
</div>
<img alt="../_images/4049f293a840d833f51c239ff606770a0959bde7f65d82374c127933f15e3c48.png" src="../_images/4049f293a840d833f51c239ff606770a0959bde7f65d82374c127933f15e3c48.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">247/247</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">1s</span> 4ms/step
inv_y shape: (7894,)
inv_yhat shape: (7894,)
Test MAPE: 1.907%
Test RMSE: 0.026
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plotting the results</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">inv_y</span><span class="p">):],</span> <span class="n">inv_y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">inv_y</span><span class="p">):],</span> <span class="n">inv_yhat</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predictions&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Power Factor&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Power Factor Predictions vs True Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/42db94efd4c215f790b3c307b6da4489655f44eb7491c2e34a77f5c1c181bc1a.png" src="../_images/42db94efd4c215f790b3c307b6da4489655f44eb7491c2e34a77f5c1c181bc1a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_bilstm</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">Model: "sequential_5"</span>
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> Layer (type)                         </span>┃<span style="font-weight: bold"> Output Shape                </span>┃<span style="font-weight: bold">         Param # </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━┩
│ bidirectional_4 (<span style="color: #0087ff; text-decoration-color: #0087ff">Bidirectional</span>)      │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">24</span>, <span style="color: #00af00; text-decoration-color: #00af00">256</span>)             │         <span style="color: #00af00; text-decoration-color: #00af00">138,240</span> │
├──────────────────────────────────────┼─────────────────────────────┼─────────────────┤
│ bidirectional_5 (<span style="color: #0087ff; text-decoration-color: #0087ff">Bidirectional</span>)      │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">128</span>)                 │         <span style="color: #00af00; text-decoration-color: #00af00">164,352</span> │
├──────────────────────────────────────┼─────────────────────────────┼─────────────────┤
│ dense_5 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                      │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>)                   │             <span style="color: #00af00; text-decoration-color: #00af00">129</span> │
└──────────────────────────────────────┴─────────────────────────────┴─────────────────┘
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Total params: </span><span style="color: #00af00; text-decoration-color: #00af00">908,165</span> (3.46 MB)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">302,721</span> (1.15 MB)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Non-trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">0</span> (0.00 B)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Optimizer params: </span><span style="color: #00af00; text-decoration-color: #00af00">605,444</span> (2.31 MB)
</pre>
</div></div>
</div>
</section>
</section>
<section id="i-think-it-is-enough-for-lstm">
<h2><strong>I think, it is enough for LSTM</strong><a class="headerlink" href="#i-think-it-is-enough-for-lstm" title="Link to this heading">#</a></h2>
<section id="gru">
<h3><em><strong>3.2.2.Gru</strong></em><a class="headerlink" href="#gru" title="Link to this heading">#</a></h3>
<section id="gru-gated-recurrent-unit-and-its-key-features">
<h4><em><strong><em>GRU (Gated Recurrent Unit) and Its Key Features</em></strong></em><br><br><a class="headerlink" href="#gru-gated-recurrent-unit-and-its-key-features" title="Link to this heading">#</a></h4>
<p>GRU is a recurrent neural network (RNN) model designed to work with sequential data, widely used in tasks such as time series forecasting. Similar to LSTM, it aims to capture long-term dependencies but has a simpler structure. GRU relies on two main components: the cell state and the hidden state. Instead of separate forget, input, and output gates like LSTM, it uses only update and reset gates. This makes it more parameter-efficient, faster to train, and computationally more efficient. Compared to LSTM, it requires less memory, making it advantageous for large datasets and real-time applications. Among time series forecasting methods, it is particularly popular due to its <em><strong>high accuracy and low computational cost</strong></em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_sequences</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates sequences from time series data for LSTM/GRU model input.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    data : numpy array</span>
<span class="sd">        Input data with shape (samples, features).</span>
<span class="sd">        The last column is assumed to be the target variable.</span>
<span class="sd">    n_steps : int</span>
<span class="sd">        Number of time steps to look back (sequence length)</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    X : numpy array</span>
<span class="sd">        Sequences with shape (samples, timesteps, features)</span>
<span class="sd">    y : numpy array</span>
<span class="sd">        Target values with shape (samples,)</span>

<span class="sd">    Example:</span>
<span class="sd">    --------</span>
<span class="sd">    # Assuming &#39;data&#39; is your numpy array with shape (1000, 5)</span>
<span class="sd">    # where last column is your target variable</span>
<span class="sd">    X, y = create_sequences(data, n_steps=30)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_steps</span><span class="p">):</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:(</span><span class="n">i</span> <span class="o">+</span> <span class="n">n_steps</span><span class="p">),</span> <span class="p">:]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">n_steps</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Last column as target</span>
        <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
        <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">MinMaxScaler</span><span class="p">,</span> <span class="n">StandardScaler</span>

<span class="n">original_columns</span> <span class="o">=</span> <span class="n">df_hourly</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># Data preprocessing</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">df_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">df_scaled</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_scaled</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">df_scaled</span><span class="p">[</span><span class="s1">&#39;Datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span>
<span class="n">df_scaled</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Datetime&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_scaled</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>voltage</th>
      <th>global_intensity</th>
      <th>sub_metering_1</th>
      <th>sub_metering_2</th>
      <th>sub_metering_3</th>
      <th>power_factor</th>
    </tr>
    <tr>
      <th>Datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2006-12-16 17:00:00</th>
      <td>-2.077988</td>
      <td>3.607876</td>
      <td>-0.319086</td>
      <td>-0.184969</td>
      <td>1.424259</td>
      <td>0.811481</td>
    </tr>
    <tr>
      <th>2006-12-16 18:00:00</th>
      <td>-2.099360</td>
      <td>2.938368</td>
      <td>-0.319086</td>
      <td>1.300378</td>
      <td>1.425020</td>
      <td>0.872132</td>
    </tr>
    <tr>
      <th>2006-12-16 19:00:00</th>
      <td>-2.551344</td>
      <td>2.644677</td>
      <td>-0.319086</td>
      <td>0.032366</td>
      <td>1.399919</td>
      <td>0.872329</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Train-test split</span>
<span class="n">train_df</span> <span class="o">=</span> <span class="n">df_scaled</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_scaled</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="s1">&#39;2010-01-01 00:00:00&#39;</span><span class="p">]</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">df_scaled</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_scaled</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="s1">&#39;2010-01-01 00:00:00&#39;</span><span class="p">]</span>

<span class="n">target_col</span> <span class="o">=</span> <span class="s1">&#39;power_factor&#39;</span>
<span class="n">feature_cols</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">target_col</span><span class="p">])</span>

<span class="c1"># Prepare data for LSTM</span>
<span class="n">X_train_raw</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">y_train_raw</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">X_test_raw</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">y_test_raw</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_steps</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">create_sequences</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">y_train_raw</span><span class="p">,</span> <span class="n">X_train_raw</span><span class="p">)),</span> <span class="n">n_steps</span><span class="p">)</span>
<span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">create_sequences</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">y_test_raw</span><span class="p">,</span> <span class="n">X_test_raw</span><span class="p">)),</span> <span class="n">n_steps</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculating metric of WAPE Weighted Absolute Percentage Error</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tensorflow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras</span><span class="w"> </span><span class="kn">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">K</span>

<span class="k">def</span><span class="w"> </span><span class="nf">wape</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">K</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">))</span> <span class="o">/</span> <span class="n">K</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.layers</span><span class="w"> </span><span class="kn">import</span> <span class="n">GRU</span><span class="p">,</span> <span class="n">Dense</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.callbacks</span><span class="w"> </span><span class="kn">import</span> <span class="n">EarlyStopping</span>


<span class="c1"># Build the GRU model</span>
<span class="n">gru_model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
<span class="n">gru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">GRU</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
<span class="n">gru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">gru_model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span><span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mean_absolute_error&quot;</span><span class="p">,</span> <span class="n">wape</span><span class="p">])</span>

<span class="c1"># Define early stopping callback</span>
<span class="n">early_stopping</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                               <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Train the model with early stopping</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">gru_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                        <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
                        <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stopping</span><span class="p">])</span>

<span class="c1"># Evaluate the model</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">gru_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The model creation process was completed successfully&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;############&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Validation Loss: </span><span class="si">{</span><span class="n">loss</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">3s</span> 5ms/step - loss: 0.6341 - mean_absolute_error: 0.6409 - wape: 2648.5283 - val_loss: 0.5361 - val_mean_absolute_error: 0.5494 - val_wape: 18608.4844
Epoch 2/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">2s</span> 4ms/step - loss: 0.4797 - mean_absolute_error: 0.5228 - wape: -125.4907 - val_loss: 0.5015 - val_mean_absolute_error: 0.5122 - val_wape: 23897.5410
Epoch 3/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">2s</span> 4ms/step - loss: 0.4528 - mean_absolute_error: 0.4996 - wape: -5181.3408 - val_loss: 0.4881 - val_mean_absolute_error: 0.5032 - val_wape: 17509.8789
Epoch 4/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">2s</span> 4ms/step - loss: 0.4464 - mean_absolute_error: 0.4948 - wape: -825.8611 - val_loss: 0.4743 - val_mean_absolute_error: 0.5128 - val_wape: 22356.2871
Epoch 5/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">2s</span> 4ms/step - loss: 0.4366 - mean_absolute_error: 0.4870 - wape: -546.8387 - val_loss: 0.4701 - val_mean_absolute_error: 0.4996 - val_wape: 20636.0742
Epoch 6/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">2s</span> 4ms/step - loss: 0.4266 - mean_absolute_error: 0.4812 - wape: 19.1141 - val_loss: 0.4722 - val_mean_absolute_error: 0.4982 - val_wape: 29492.9395
Epoch 7/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">2s</span> 4ms/step - loss: 0.4223 - mean_absolute_error: 0.4736 - wape: -67.1488 - val_loss: 0.4738 - val_mean_absolute_error: 0.4990 - val_wape: 23412.0020
Epoch 8/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">2s</span> 4ms/step - loss: 0.4144 - mean_absolute_error: 0.4687 - wape: 184.6494 - val_loss: 0.4598 - val_mean_absolute_error: 0.4900 - val_wape: 28253.1387
Epoch 9/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">2s</span> 4ms/step - loss: 0.3976 - mean_absolute_error: 0.4580 - wape: -384.8196 - val_loss: 0.4467 - val_mean_absolute_error: 0.4805 - val_wape: 27555.0547
Epoch 10/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">2s</span> 4ms/step - loss: 0.3993 - mean_absolute_error: 0.4550 - wape: -648.5257 - val_loss: 0.4588 - val_mean_absolute_error: 0.4896 - val_wape: 28737.4102
Epoch 11/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">2s</span> 4ms/step - loss: 0.3887 - mean_absolute_error: 0.4477 - wape: -160.1194 - val_loss: 0.4593 - val_mean_absolute_error: 0.4875 - val_wape: 23243.1816
Epoch 12/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">2s</span> 4ms/step - loss: 0.3765 - mean_absolute_error: 0.4374 - wape: 88.9029 - val_loss: 0.4441 - val_mean_absolute_error: 0.4741 - val_wape: 23305.7422
Epoch 13/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">2s</span> 4ms/step - loss: 0.3665 - mean_absolute_error: 0.4303 - wape: 918.2894 - val_loss: 0.4359 - val_mean_absolute_error: 0.4723 - val_wape: 18664.1914
Epoch 14/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">2s</span> 4ms/step - loss: 0.3539 - mean_absolute_error: 0.4208 - wape: -403.0081 - val_loss: 0.4311 - val_mean_absolute_error: 0.4749 - val_wape: 15865.8789
Epoch 15/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">2s</span> 4ms/step - loss: 0.3513 - mean_absolute_error: 0.4201 - wape: -1459.6066 - val_loss: 0.4317 - val_mean_absolute_error: 0.4602 - val_wape: 18830.3105
Epoch 16/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">2s</span> 4ms/step - loss: 0.3388 - mean_absolute_error: 0.4088 - wape: 5601.4990 - val_loss: 0.4241 - val_mean_absolute_error: 0.4690 - val_wape: 18553.8203
Epoch 17/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">2s</span> 4ms/step - loss: 0.3412 - mean_absolute_error: 0.4132 - wape: -963.5680 - val_loss: 0.4171 - val_mean_absolute_error: 0.4435 - val_wape: 1495.8922
Epoch 18/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">2s</span> 4ms/step - loss: 0.3260 - mean_absolute_error: 0.4001 - wape: -918.4715 - val_loss: 0.4245 - val_mean_absolute_error: 0.4676 - val_wape: 1621.5928
Epoch 19/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">2s</span> 4ms/step - loss: 0.3145 - mean_absolute_error: 0.3940 - wape: 579.4114 - val_loss: 0.4207 - val_mean_absolute_error: 0.4550 - val_wape: 12795.4639
Epoch 20/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">2s</span> 4ms/step - loss: 0.3072 - mean_absolute_error: 0.3883 - wape: 1363.2804 - val_loss: 0.4238 - val_mean_absolute_error: 0.4585 - val_wape: 2345.8223
<span class=" -Color -Color-Bold">247/247</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 2ms/step - loss: 0.4152 - mean_absolute_error: 0.4437 - wape: -3677.4365
The model creation process was completed successfully
############
Validation Loss: [0.4171126186847687, 0.4434625804424286, -11146.3203125]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># data check</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;X_train shape:&quot;</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;y_train shape:&quot;</span><span class="p">,</span> <span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;X_train data type:&quot;</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;y_train data type:&quot;</span><span class="p">,</span> <span class="n">y_train</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

<span class="c1"># NaN and Infinity checking</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of X_train NaN :&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of y_train NaN :&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of X_train Infinity :&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of y_train Infinity :&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>X_train shape: (26647, 24, 6)
y_train shape: (26647,)
X_train data type: float64
y_train data type: float64
number of X_train NaN : 0
number of y_train NaN : 0
number of X_train Infinity : 0
number of y_train Infinity : 0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Make predictions</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">gru_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Ensure the predicted values and test values have the same length</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># Convert to 1D array</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># ** Fix the inverse transform issue **</span>

<span class="c1"># Create an empty array for inverse transformation</span>
<span class="n">dummy_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">y_pred</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_columns</span><span class="p">)))</span>

<span class="c1"># Assign predicted values to the correct column index</span>
<span class="n">target_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">original_columns</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">target_col</span><span class="p">)</span>
<span class="n">dummy_data</span><span class="p">[:,</span> <span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred</span>

<span class="c1"># Inverse transform using the original scaler</span>
<span class="n">inv_y_pred</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)[:,</span> <span class="n">target_index</span><span class="p">]</span>

<span class="c1"># Do the same for actual values</span>
<span class="n">dummy_data</span><span class="p">[:,</span> <span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test</span>
<span class="n">inv_y</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)[:,</span> <span class="n">target_index</span><span class="p">]</span>

<span class="c1"># Check for shape consistency before computing metrics</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inv_y shape:&quot;</span><span class="p">,</span> <span class="n">inv_y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inv_yhat shape:&quot;</span><span class="p">,</span> <span class="n">inv_y_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Calculate metrics</span>
<span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">inv_y</span><span class="p">,</span> <span class="n">inv_y_pred</span><span class="p">))</span>
<span class="n">mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">inv_y</span> <span class="o">-</span> <span class="n">inv_y_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">inv_y</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test MAPE: </span><span class="si">%.3f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test RMSE: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rmse</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9bb308493940a50d0a5cde43fb435610c719ed9eabd57b45b4917db40cda843d.png" src="../_images/9bb308493940a50d0a5cde43fb435610c719ed9eabd57b45b4917db40cda843d.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">247/247</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 2ms/step
inv_y shape: (7894,)
inv_yhat shape: (7894,)
Test MAPE: 1.842%
Test RMSE: 0.026
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plotting the results</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">inv_y</span><span class="p">):],</span> <span class="n">inv_y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">inv_y</span><span class="p">):],</span> <span class="n">inv_y_pred</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predictions&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Power Factor&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Power Factor Predictions vs True Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/798b787e9798e7da2bb60a8b98a04b175f06cad043d0c8667f301dd03d40bae5.png" src="../_images/798b787e9798e7da2bb60a8b98a04b175f06cad043d0c8667f301dd03d40bae5.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">gru_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_test</span><span class="p">[:</span><span class="mi">100</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual Values&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[:</span><span class="mi">100</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Estimated Values&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Actual vs Prediction for First 100 Data Points&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time Step&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">247/247</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 1ms/step
</pre></div>
</div>
<img alt="../_images/8f2d33aee422d9b20bb632433d72407229fa2e427f14535d3c3d125497374a5d.png" src="../_images/8f2d33aee422d9b20bb632433d72407229fa2e427f14535d3c3d125497374a5d.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.layers</span><span class="w"> </span><span class="kn">import</span> <span class="n">GRU</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span><span class="n">Dropout</span><span class="p">,</span><span class="n">BatchNormalization</span><span class="p">,</span><span class="n">LeakyReLU</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.callbacks</span><span class="w"> </span><span class="kn">import</span> <span class="n">EarlyStopping</span><span class="p">,</span><span class="n">ReduceLROnPlateau</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.regularizers</span><span class="w"> </span><span class="kn">import</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">l1_l2</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.optimizers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>

<span class="c1"># Build the GRU model</span>
<span class="n">gru_model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
<span class="n">gru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">GRU</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                   <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>
                   <span class="n">recurrent_regularizer</span><span class="o">=</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))</span>
                   <span class="p">)</span> <span class="c1"># to improve measures of over-fitting</span>
<span class="n">gru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BatchNormalization</span><span class="p">())</span>
<span class="n">gru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
<span class="n">gru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)))</span>
<span class="n">gru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BatchNormalization</span><span class="p">())</span>
<span class="n">gru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
<span class="n">gru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)))</span>
<span class="n">gru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="n">gru_model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">clipnorm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span>
                  <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span>
                  <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mean_absolute_error&quot;</span><span class="p">,</span> <span class="n">wape</span><span class="p">])</span>
<span class="c1"># clipnorm=1.0 for Gradient clipping</span>

<span class="c1"># Define early stopping callback</span>
<span class="n">early_stopping</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>
                               <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                               <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Adaptive Learning Rate</span>
<span class="c1"># reduce_lr = ReduceLROnPlateau(</span>
<span class="c1">#     monitor=&#39;val_loss&#39;,</span>
<span class="c1">#     factor=0.5,  # Cut your learning rate in half</span>
<span class="c1">#     patience=5,  # If there is no improvement for 5 epochs</span>
<span class="c1">#     min_lr=1e-5</span>
<span class="c1"># )</span>
<span class="c1"># Train the model with early stopping</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">gru_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
                        <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                        <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
                        <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stopping</span><span class="p">])</span>

<span class="c1"># Evaluate the model</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">gru_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The model creation process was completed successfully &quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;############&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Validation Loss: </span><span class="si">{</span><span class="n">loss</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Plot training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">8s</span> 8ms/step - loss: 1.4641 - mean_absolute_error: 0.7148 - wape: -1021.9204 - val_loss: 0.6441 - val_mean_absolute_error: 0.6199 - val_wape: 24333.3613
Epoch 2/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">3s</span> 8ms/step - loss: 0.6368 - mean_absolute_error: 0.5844 - wape: -3.6741 - val_loss: 0.5637 - val_mean_absolute_error: 0.5775 - val_wape: 2467.0256
Epoch 3/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">3s</span> 8ms/step - loss: 0.5851 - mean_absolute_error: 0.5679 - wape: -12566.0850 - val_loss: 0.5467 - val_mean_absolute_error: 0.5591 - val_wape: 27128.7285
Epoch 4/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">3s</span> 8ms/step - loss: 0.5512 - mean_absolute_error: 0.5458 - wape: -6056.9204 - val_loss: 0.5275 - val_mean_absolute_error: 0.5178 - val_wape: 5879.3799
Epoch 5/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">3s</span> 8ms/step - loss: 0.5406 - mean_absolute_error: 0.5426 - wape: -564.9587 - val_loss: 0.5203 - val_mean_absolute_error: 0.5312 - val_wape: 8255.5312
Epoch 6/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">3s</span> 8ms/step - loss: 0.5384 - mean_absolute_error: 0.5436 - wape: -279.0384 - val_loss: 0.5197 - val_mean_absolute_error: 0.5144 - val_wape: 6360.6465
Epoch 7/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">3s</span> 8ms/step - loss: 0.5339 - mean_absolute_error: 0.5447 - wape: 57.9274 - val_loss: 0.5042 - val_mean_absolute_error: 0.5516 - val_wape: 26047.3887
Epoch 8/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">3s</span> 8ms/step - loss: 0.5119 - mean_absolute_error: 0.5278 - wape: -13605.7637 - val_loss: 0.5318 - val_mean_absolute_error: 0.4957 - val_wape: 6856.4604
Epoch 9/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">3s</span> 8ms/step - loss: 0.5151 - mean_absolute_error: 0.5278 - wape: -6907.3896 - val_loss: 0.5153 - val_mean_absolute_error: 0.4946 - val_wape: 10594.1543
Epoch 10/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">3s</span> 8ms/step - loss: 0.5194 - mean_absolute_error: 0.5312 - wape: -21678.5801 - val_loss: 0.4869 - val_mean_absolute_error: 0.4989 - val_wape: 45487.6445
Epoch 11/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">3s</span> 8ms/step - loss: 0.5065 - mean_absolute_error: 0.5206 - wape: 1621.7373 - val_loss: 0.4912 - val_mean_absolute_error: 0.4914 - val_wape: 36513.0156
Epoch 12/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">3s</span> 8ms/step - loss: 0.5000 - mean_absolute_error: 0.5149 - wape: 105.9392 - val_loss: 0.4885 - val_mean_absolute_error: 0.4917 - val_wape: 34647.8477
Epoch 13/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">3s</span> 8ms/step - loss: 0.5004 - mean_absolute_error: 0.5194 - wape: 369.9525 - val_loss: 0.4941 - val_mean_absolute_error: 0.5203 - val_wape: 42348.3008
Epoch 14/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">3s</span> 8ms/step - loss: 0.4990 - mean_absolute_error: 0.5195 - wape: -82.5398 - val_loss: 0.5097 - val_mean_absolute_error: 0.5022 - val_wape: 21066.3516
Epoch 15/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">3s</span> 8ms/step - loss: 0.4945 - mean_absolute_error: 0.5131 - wape: 1038.2379 - val_loss: 0.4999 - val_mean_absolute_error: 0.5030 - val_wape: 32579.2617
Epoch 16/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">3s</span> 8ms/step - loss: 0.4973 - mean_absolute_error: 0.5159 - wape: -83.7622 - val_loss: 0.4831 - val_mean_absolute_error: 0.5075 - val_wape: 3326.2207
Epoch 17/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">3s</span> 8ms/step - loss: 0.4923 - mean_absolute_error: 0.5127 - wape: 676.5080 - val_loss: 0.4865 - val_mean_absolute_error: 0.4806 - val_wape: 3086.0928
Epoch 18/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">3s</span> 8ms/step - loss: 0.4828 - mean_absolute_error: 0.5025 - wape: -932.5305 - val_loss: 0.4775 - val_mean_absolute_error: 0.4954 - val_wape: 24027.3301
Epoch 19/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">3s</span> 8ms/step - loss: 0.4830 - mean_absolute_error: 0.5077 - wape: 9.5830 - val_loss: 0.4869 - val_mean_absolute_error: 0.5016 - val_wape: 3770.2122
Epoch 20/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">3s</span> 8ms/step - loss: 0.4845 - mean_absolute_error: 0.5052 - wape: -2299.1367 - val_loss: 0.4856 - val_mean_absolute_error: 0.5006 - val_wape: 23047.6738
<span class=" -Color -Color-Bold">247/247</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">1s</span> 2ms/step - loss: 0.4685 - mean_absolute_error: 0.5025 - wape: 4729.6260
The model creation process was completed successfully 
############
Validation Loss: [0.4774920642375946, 0.49544957280158997, 3963.8203125]
</pre></div>
</div>
<img alt="../_images/84f1ec8b0aaf2bc10302797eeb0a18d5b21a4ec9331ef7d9bcaf40d0acd76d00.png" src="../_images/84f1ec8b0aaf2bc10302797eeb0a18d5b21a4ec9331ef7d9bcaf40d0acd76d00.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_percentage_error</span>

<span class="c1"># Make predictions</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">gru_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Ensure the predicted values and test values have the same length</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># Convert to 1D array</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># ** Fix the inverse transform issue **</span>

<span class="c1"># Create an empty array for inverse transformation</span>
<span class="n">dummy_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">y_pred</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_columns</span><span class="p">)))</span>

<span class="c1"># Assign predicted values to the correct column index</span>
<span class="n">target_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">original_columns</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">target_col</span><span class="p">)</span>
<span class="n">dummy_data</span><span class="p">[:,</span> <span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred</span>

<span class="c1"># Inverse transform using the original scaler</span>
<span class="n">inv_y_pred</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)[:,</span> <span class="n">target_index</span><span class="p">]</span>

<span class="c1"># Do the same for actual values</span>
<span class="n">dummy_data</span><span class="p">[:,</span> <span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test</span>
<span class="n">inv_y</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)[:,</span> <span class="n">target_index</span><span class="p">]</span>

<span class="c1"># Check for shape consistency before computing metrics</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inv_y shape:&quot;</span><span class="p">,</span> <span class="n">inv_y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inv_yhat shape:&quot;</span><span class="p">,</span> <span class="n">inv_y_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Calculate metrics</span>
<span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">inv_y</span><span class="p">,</span> <span class="n">inv_y_pred</span><span class="p">))</span>
<span class="n">mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">inv_y</span> <span class="o">-</span> <span class="n">inv_y_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">inv_y</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test MAPE: </span><span class="si">%.3f%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test RMSE: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rmse</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">247/247</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">1s</span> 2ms/step
inv_y shape: (7894,)
inv_yhat shape: (7894,)
Test MAPE: 2.051%
Test RMSE: 0.027
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plotting the results</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">inv_y</span><span class="p">):],</span> <span class="n">inv_y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">inv_y</span><span class="p">):],</span> <span class="n">inv_y_pred</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predictions&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Power Factor&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Power Factor Predictions vs True Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8b0537fa7ac77f431d00c5e18d32637927c0e151c8039a5e9317a32dcb7a9b32.png" src="../_images/8b0537fa7ac77f431d00c5e18d32637927c0e151c8039a5e9317a32dcb7a9b32.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">gru_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_test</span><span class="p">[:</span><span class="mi">100</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual Values&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[:</span><span class="mi">100</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Estimated Values&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Actual vs Prediction for First 100 Data Points&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time Step&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">247/247</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">0s</span> 2ms/step
</pre></div>
</div>
<img alt="../_images/d90b5e308978928e4db912cc6e45e2424f216163f5b39f772e72037143be7c6c.png" src="../_images/d90b5e308978928e4db912cc6e45e2424f216163f5b39f772e72037143be7c6c.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.layers</span><span class="w"> </span><span class="kn">import</span> <span class="n">GRU</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span><span class="n">Dropout</span><span class="p">,</span><span class="n">BatchNormalization</span><span class="p">,</span><span class="n">LeakyReLU</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.callbacks</span><span class="w"> </span><span class="kn">import</span> <span class="n">EarlyStopping</span><span class="p">,</span><span class="n">ReduceLROnPlateau</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.layers</span><span class="w"> </span><span class="kn">import</span> <span class="n">GRU</span><span class="p">,</span> <span class="n">Bidirectional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.regularizers</span><span class="w"> </span><span class="kn">import</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">l1_l2</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.optimizers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span>

<span class="c1"># Build the GRU model</span>
<span class="n">bi_gru_model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
<span class="n">bi_gru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Bidirectional</span><span class="p">(</span><span class="n">GRU</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                   <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>
                   <span class="n">recurrent_regularizer</span><span class="o">=</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))</span>
                   <span class="p">))</span> <span class="c1"># to improve measures of over-fitting</span>
<span class="n">bi_gru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BatchNormalization</span><span class="p">())</span>
<span class="n">bi_gru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
<span class="n">bi_gru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)))</span>
<span class="n">bi_gru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BatchNormalization</span><span class="p">())</span>
<span class="n">bi_gru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
<span class="n">bi_gru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)))</span>
<span class="n">bi_gru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="n">bi_gru_model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0003</span><span class="p">,</span><span class="n">clipnorm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span>
                  <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span>
                  <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mean_absolute_error&quot;</span><span class="p">,</span> <span class="n">wape</span><span class="p">])</span>
<span class="c1"># clipnorm=1.0 for Gradient clipping</span>

<span class="c1"># Define early stopping callback</span>
<span class="n">early_stopping</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>
                               <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                               <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Adaptive Learning Rate</span>
<span class="c1"># reduce_lr = ReduceLROnPlateau(</span>
<span class="c1">#     monitor=&#39;val_loss&#39;,</span>
<span class="c1">#     factor=0.5,  # Cut your learning rate in half</span>
<span class="c1">#     patience=5,  # If there is no improvement for 5 epochs</span>
<span class="c1">#     min_lr=1e-5</span>
<span class="c1"># )</span>
<span class="c1"># Train the model with early stopping</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">bi_gru_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
                        <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                        <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
                        <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stopping</span><span class="p">])</span>

<span class="c1"># Evaluate the model</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">bi_gru_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The model creation process was completed successfully &quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;############&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Validation Loss: </span><span class="si">{</span><span class="n">loss</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Plot training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">8s</span> 11ms/step - loss: 2.9873 - mean_absolute_error: 0.8300 - wape: 1750.7018 - val_loss: 1.1111 - val_mean_absolute_error: 0.5937 - val_wape: 33374.8516
Epoch 2/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 1.0402 - mean_absolute_error: 0.6059 - wape: -2774.9021 - val_loss: 0.7491 - val_mean_absolute_error: 0.5298 - val_wape: 46081.1055
Epoch 3/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.7565 - mean_absolute_error: 0.5849 - wape: 1387.2592 - val_loss: 0.6307 - val_mean_absolute_error: 0.5212 - val_wape: 40076.8086
Epoch 4/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.6473 - mean_absolute_error: 0.5684 - wape: 54.7904 - val_loss: 0.5852 - val_mean_absolute_error: 0.5181 - val_wape: 47501.7773
Epoch 5/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5852 - mean_absolute_error: 0.5485 - wape: 1452.7526 - val_loss: 0.5615 - val_mean_absolute_error: 0.5313 - val_wape: 46124.7305
Epoch 6/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5761 - mean_absolute_error: 0.5506 - wape: -1076.0433 - val_loss: 0.5421 - val_mean_absolute_error: 0.5257 - val_wape: 41050.5117
Epoch 7/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5744 - mean_absolute_error: 0.5570 - wape: -586.6997 - val_loss: 0.5328 - val_mean_absolute_error: 0.5163 - val_wape: 34951.5000
Epoch 8/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5510 - mean_absolute_error: 0.5455 - wape: -201.8555 - val_loss: 0.5148 - val_mean_absolute_error: 0.5112 - val_wape: 35251.4570
Epoch 9/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5484 - mean_absolute_error: 0.5471 - wape: 3379.2017 - val_loss: 0.5243 - val_mean_absolute_error: 0.4986 - val_wape: 28600.9863
Epoch 10/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5317 - mean_absolute_error: 0.5353 - wape: -11304.1104 - val_loss: 0.5206 - val_mean_absolute_error: 0.5011 - val_wape: 33019.8398
Epoch 11/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5326 - mean_absolute_error: 0.5378 - wape: -1665.8394 - val_loss: 0.5042 - val_mean_absolute_error: 0.5150 - val_wape: 26659.4531
Epoch 12/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5351 - mean_absolute_error: 0.5397 - wape: 545.5095 - val_loss: 0.4997 - val_mean_absolute_error: 0.5050 - val_wape: 18757.3125
Epoch 13/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5168 - mean_absolute_error: 0.5285 - wape: 218.8330 - val_loss: 0.4907 - val_mean_absolute_error: 0.4908 - val_wape: 19566.0762
Epoch 14/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5207 - mean_absolute_error: 0.5315 - wape: 6875.9194 - val_loss: 0.4899 - val_mean_absolute_error: 0.4753 - val_wape: 15008.0752
Epoch 15/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5117 - mean_absolute_error: 0.5257 - wape: -74.2781 - val_loss: 0.4803 - val_mean_absolute_error: 0.5015 - val_wape: 9709.8555
Epoch 16/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5092 - mean_absolute_error: 0.5279 - wape: -5203.4897 - val_loss: 0.4820 - val_mean_absolute_error: 0.4781 - val_wape: 12457.6494
Epoch 17/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.4983 - mean_absolute_error: 0.5212 - wape: 316.9578 - val_loss: 0.4761 - val_mean_absolute_error: 0.4936 - val_wape: 5318.0684
Epoch 18/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5009 - mean_absolute_error: 0.5229 - wape: 396.1671 - val_loss: 0.4929 - val_mean_absolute_error: 0.4820 - val_wape: 2873.0774
Epoch 19/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 9ms/step - loss: 0.5005 - mean_absolute_error: 0.5179 - wape: -164.6124 - val_loss: 0.4773 - val_mean_absolute_error: 0.4706 - val_wape: 12032.1016
Epoch 20/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 9ms/step - loss: 0.4882 - mean_absolute_error: 0.5108 - wape: 488.3288 - val_loss: 0.4628 - val_mean_absolute_error: 0.4679 - val_wape: 15388.1475
<span class=" -Color -Color-Bold">247/247</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">1s</span> 3ms/step - loss: 0.4538 - mean_absolute_error: 0.4726 - wape: 6740.3188
The model creation process was completed successfully 
############
Validation Loss: [0.4627801179885864, 0.4679456353187561, -685.7330932617188]
</pre></div>
</div>
<img alt="../_images/09a144e174fa869ab2eccf040a45e40f1be91e76241e59a1c77f384fad642e6f.png" src="../_images/09a144e174fa869ab2eccf040a45e40f1be91e76241e59a1c77f384fad642e6f.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_percentage_error</span><span class="p">,</span><span class="n">mean_absolute_error</span>

<span class="c1"># Make predictions</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">bi_gru_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Ensure the predicted values and test values have the same length</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># Convert to 1D array</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># ** Fix the inverse transform issue **</span>

<span class="c1"># Create an empty array for inverse transformation</span>
<span class="n">dummy_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">y_pred</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_columns</span><span class="p">)))</span>

<span class="c1"># Assign predicted values to the correct column index</span>
<span class="n">target_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">original_columns</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">target_col</span><span class="p">)</span>
<span class="n">dummy_data</span><span class="p">[:,</span> <span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred</span>

<span class="c1"># Inverse transform using the original scaler</span>
<span class="n">inv_y_pred</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)[:,</span> <span class="n">target_index</span><span class="p">]</span>

<span class="c1"># Do the same for actual values</span>
<span class="n">dummy_data</span><span class="p">[:,</span> <span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test</span>
<span class="n">inv_y</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)[:,</span> <span class="n">target_index</span><span class="p">]</span>

<span class="c1"># Check for shape consistency before computing metrics</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inv_y shape:&quot;</span><span class="p">,</span> <span class="n">inv_y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inv_yhat shape:&quot;</span><span class="p">,</span> <span class="n">inv_y_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Calculate metrics</span>
<span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">inv_y</span><span class="p">,</span> <span class="n">inv_y_pred</span><span class="p">)</span>
<span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">inv_y</span><span class="p">,</span> <span class="n">inv_y_pred</span><span class="p">))</span>
<span class="n">mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">inv_y</span> <span class="o">-</span> <span class="n">inv_y_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">inv_y</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAE: </span><span class="si">{</span><span class="n">mae</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAPE:  % </span><span class="si">{</span><span class="n">mape</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RMSE: </span><span class="si">{</span><span class="n">rmse</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">247/247</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">1s</span> 3ms/step
inv_y shape: (7894,)
inv_yhat shape: (7894,)
MAE: 0.019
MAPE:  % 1.941
RMSE: 0.027
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plotting the results</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">inv_y</span><span class="p">):],</span> <span class="n">inv_y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">inv_y</span><span class="p">):],</span> <span class="n">inv_y_pred</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predictions&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Power Factor&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Power Factor Predictions vs True Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0329617eafba71818f837ea4b6567a78505ffd65ffde821d6a97a7d6997659bb.png" src="../_images/0329617eafba71818f837ea4b6567a78505ffd65ffde821d6a97a7d6997659bb.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.layers</span><span class="w"> </span><span class="kn">import</span> <span class="n">GRU</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span><span class="n">Dropout</span><span class="p">,</span><span class="n">BatchNormalization</span><span class="p">,</span><span class="n">LeakyReLU</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.callbacks</span><span class="w"> </span><span class="kn">import</span> <span class="n">EarlyStopping</span><span class="p">,</span><span class="n">ReduceLROnPlateau</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.layers</span><span class="w"> </span><span class="kn">import</span> <span class="n">GRU</span><span class="p">,</span> <span class="n">Bidirectional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.regularizers</span><span class="w"> </span><span class="kn">import</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">l1_l2</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.optimizers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Adam</span><span class="p">,</span><span class="n">SGD</span>

<span class="c1"># Build the GRU model</span>
<span class="n">bigru_model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
<span class="n">bigru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Bidirectional</span><span class="p">(</span><span class="n">GRU</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span>
                   <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                   <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.03</span><span class="p">),</span>
                   <span class="n">recurrent_regularizer</span><span class="o">=</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.03</span><span class="p">))</span>
                   <span class="p">))</span> <span class="c1"># to improve measures of over-fitting</span>
<span class="n">bigru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BatchNormalization</span><span class="p">())</span>
<span class="n">bigru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
<span class="n">bigru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">))</span>
<span class="n">bigru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BatchNormalization</span><span class="p">())</span>
<span class="n">bigru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
<span class="n">bigru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">bigru_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.0003</span><span class="p">,</span>
    <span class="n">clipnorm</span><span class="o">=</span><span class="mf">1.0</span>           <span class="c1"># gradient clipping</span>
<span class="p">)</span>

<span class="n">bigru_model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
                  <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span>
                  <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mean_absolute_error&quot;</span><span class="p">,</span> <span class="n">wape</span><span class="p">])</span>
<span class="c1"># clipnorm=1.0 for Gradient clipping</span>

<span class="c1"># Define early stopping callback</span>
<span class="n">early_stopping</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>
                               <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                               <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="c1"># Train the model with early stopping</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">bigru_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
                        <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                        <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
                        <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stopping</span><span class="p">])</span>

<span class="c1"># Evaluate the model</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">bigru_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The model creation process was completed successfully &quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;############&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Validation Loss: </span><span class="si">{</span><span class="n">loss</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Plot training history</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">8s</span> 11ms/step - loss: 5.6863 - mean_absolute_error: 0.7421 - wape: 2212.2170 - val_loss: 1.2225 - val_mean_absolute_error: 0.6083 - val_wape: 23465.0273
Epoch 2/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 1.0584 - mean_absolute_error: 0.6095 - wape: 1024.0326 - val_loss: 0.7055 - val_mean_absolute_error: 0.5527 - val_wape: 28620.4395
Epoch 3/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.7368 - mean_absolute_error: 0.5888 - wape: -303.5836 - val_loss: 0.6284 - val_mean_absolute_error: 0.5240 - val_wape: 35597.4336
Epoch 4/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.6678 - mean_absolute_error: 0.5777 - wape: 963.3101 - val_loss: 0.5900 - val_mean_absolute_error: 0.5597 - val_wape: 21684.3926
Epoch 5/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.6085 - mean_absolute_error: 0.5597 - wape: -234.8136 - val_loss: 0.5623 - val_mean_absolute_error: 0.5340 - val_wape: 26450.9297
Epoch 6/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5822 - mean_absolute_error: 0.5518 - wape: -805.7003 - val_loss: 0.5405 - val_mean_absolute_error: 0.5130 - val_wape: 21560.4746
Epoch 7/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5733 - mean_absolute_error: 0.5523 - wape: -847.7488 - val_loss: 0.5325 - val_mean_absolute_error: 0.5188 - val_wape: 21234.2090
Epoch 8/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5605 - mean_absolute_error: 0.5501 - wape: 115.5274 - val_loss: 0.5274 - val_mean_absolute_error: 0.5245 - val_wape: 31254.8418
Epoch 9/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5495 - mean_absolute_error: 0.5481 - wape: -2.7795 - val_loss: 0.5181 - val_mean_absolute_error: 0.5215 - val_wape: 27268.5137
Epoch 10/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5391 - mean_absolute_error: 0.5408 - wape: -444.0028 - val_loss: 0.5134 - val_mean_absolute_error: 0.5070 - val_wape: 13926.9727
Epoch 11/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5309 - mean_absolute_error: 0.5382 - wape: -2844.3901 - val_loss: 0.4981 - val_mean_absolute_error: 0.5087 - val_wape: 11841.8076
Epoch 12/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5221 - mean_absolute_error: 0.5334 - wape: 220.3231 - val_loss: 0.4968 - val_mean_absolute_error: 0.4987 - val_wape: 16074.7637
Epoch 13/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5022 - mean_absolute_error: 0.5203 - wape: 2413.7693 - val_loss: 0.4967 - val_mean_absolute_error: 0.5003 - val_wape: 6001.9756
Epoch 14/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5161 - mean_absolute_error: 0.5315 - wape: -465.9814 - val_loss: 0.4877 - val_mean_absolute_error: 0.4971 - val_wape: 2721.4900
Epoch 15/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5157 - mean_absolute_error: 0.5303 - wape: -193.8320 - val_loss: 0.4833 - val_mean_absolute_error: 0.5031 - val_wape: 3926.8862
Epoch 16/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5033 - mean_absolute_error: 0.5230 - wape: -213.3753 - val_loss: 0.4959 - val_mean_absolute_error: 0.5192 - val_wape: 4066.5281
Epoch 17/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5057 - mean_absolute_error: 0.5253 - wape: 284.8115 - val_loss: 0.4739 - val_mean_absolute_error: 0.4979 - val_wape: 8930.1455
Epoch 18/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.5065 - mean_absolute_error: 0.5262 - wape: -5782.3750 - val_loss: 0.4779 - val_mean_absolute_error: 0.5134 - val_wape: 6822.1479
Epoch 19/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.4918 - mean_absolute_error: 0.5168 - wape: 863.0494 - val_loss: 0.4820 - val_mean_absolute_error: 0.4971 - val_wape: 2281.2727
Epoch 20/20
<span class=" -Color -Color-Bold">417/417</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">4s</span> 10ms/step - loss: 0.4925 - mean_absolute_error: 0.5156 - wape: 1130.4893 - val_loss: 0.4873 - val_mean_absolute_error: 0.5322 - val_wape: 17079.6895
<span class=" -Color -Color-Bold">247/247</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">1s</span> 3ms/step - loss: 0.4715 - mean_absolute_error: 0.5042 - wape: 9142.3779
The model creation process was completed successfully 
############
Validation Loss: [0.4739307165145874, 0.49790433049201965, -2596.701171875]
</pre></div>
</div>
<img alt="../_images/cb1c3fdd9ebefaf53d6c78aaa01184b117dc81cda378bd5728ae8fb0983be495.png" src="../_images/cb1c3fdd9ebefaf53d6c78aaa01184b117dc81cda378bd5728ae8fb0983be495.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_percentage_error</span><span class="p">,</span><span class="n">mean_absolute_error</span>

<span class="c1"># Make predictions</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">bigru_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Ensure the predicted values and test values have the same length</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># Convert to 1D array</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># ** Fix the inverse transform issue **</span>

<span class="c1"># Create an empty array for inverse transformation</span>
<span class="n">dummy_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">y_pred</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_columns</span><span class="p">)))</span>

<span class="c1"># Assign predicted values to the correct column index</span>
<span class="n">target_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">original_columns</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">target_col</span><span class="p">)</span>
<span class="n">dummy_data</span><span class="p">[:,</span> <span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred</span>

<span class="c1"># Inverse transform using the original scaler</span>
<span class="n">inv_y_pred</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)[:,</span> <span class="n">target_index</span><span class="p">]</span>

<span class="c1"># Do the same for actual values</span>
<span class="n">dummy_data</span><span class="p">[:,</span> <span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test</span>
<span class="n">inv_y</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">)[:,</span> <span class="n">target_index</span><span class="p">]</span>

<span class="c1"># Check for shape consistency before computing metrics</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inv_y shape:&quot;</span><span class="p">,</span> <span class="n">inv_y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inv_yhat shape:&quot;</span><span class="p">,</span> <span class="n">inv_y_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Calculate metrics</span>
<span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">inv_y</span><span class="p">,</span> <span class="n">inv_y_pred</span><span class="p">)</span>
<span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">inv_y</span><span class="p">,</span> <span class="n">inv_y_pred</span><span class="p">))</span>
<span class="n">mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">inv_y</span> <span class="o">-</span> <span class="n">inv_y_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">inv_y</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAE: </span><span class="si">{</span><span class="n">mae</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAPE:  % </span><span class="si">{</span><span class="n">mape</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RMSE: </span><span class="si">{</span><span class="n">rmse</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">247/247</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">1s</span> 4ms/step
inv_y shape: (7894,)
inv_yhat shape: (7894,)
MAE: 0.020
MAPE:  % 2.070
RMSE: 0.027
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plotting the results</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">inv_y</span><span class="p">):],</span> <span class="n">inv_y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">inv_y</span><span class="p">):],</span> <span class="n">inv_y_pred</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predictions&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Power Factor&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Power Factor Predictions vs True Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5aeb293b3e256b64938151c7fdff951afaead95e0b88891b3a9516f1ac0f1ed2.png" src="../_images/5aeb293b3e256b64938151c7fdff951afaead95e0b88891b3a9516f1ac0f1ed2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bigru_model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">Model: "sequential_9"</span>
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> Layer (type)                         </span>┃<span style="font-weight: bold"> Output Shape                </span>┃<span style="font-weight: bold">         Param # </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━┩
│ bidirectional_7 (<span style="color: #0087ff; text-decoration-color: #0087ff">Bidirectional</span>)      │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">256</span>)                 │         <span style="color: #00af00; text-decoration-color: #00af00">104,448</span> │
├──────────────────────────────────────┼─────────────────────────────┼─────────────────┤
│ batch_normalization_4                │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">256</span>)                 │           <span style="color: #00af00; text-decoration-color: #00af00">1,024</span> │
│ (<span style="color: #0087ff; text-decoration-color: #0087ff">BatchNormalization</span>)                 │                             │                 │
├──────────────────────────────────────┼─────────────────────────────┼─────────────────┤
│ dropout_6 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dropout</span>)                  │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">256</span>)                 │               <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
├──────────────────────────────────────┼─────────────────────────────┼─────────────────┤
│ dense_13 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                     │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">64</span>)                  │          <span style="color: #00af00; text-decoration-color: #00af00">16,448</span> │
├──────────────────────────────────────┼─────────────────────────────┼─────────────────┤
│ batch_normalization_5                │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">64</span>)                  │             <span style="color: #00af00; text-decoration-color: #00af00">256</span> │
│ (<span style="color: #0087ff; text-decoration-color: #0087ff">BatchNormalization</span>)                 │                             │                 │
├──────────────────────────────────────┼─────────────────────────────┼─────────────────┤
│ dropout_7 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dropout</span>)                  │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">64</span>)                  │               <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
├──────────────────────────────────────┼─────────────────────────────┼─────────────────┤
│ dense_14 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                     │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">32</span>)                  │           <span style="color: #00af00; text-decoration-color: #00af00">2,080</span> │
├──────────────────────────────────────┼─────────────────────────────┼─────────────────┤
│ dense_15 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                     │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>)                   │              <span style="color: #00af00; text-decoration-color: #00af00">33</span> │
└──────────────────────────────────────┴─────────────────────────────┴─────────────────┘
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Total params: </span><span style="color: #00af00; text-decoration-color: #00af00">371,589</span> (1.42 MB)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">123,649</span> (483.00 KB)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Non-trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">640</span> (2.50 KB)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Optimizer params: </span><span style="color: #00af00; text-decoration-color: #00af00">247,300</span> (966.02 KB)
</pre>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">error_per</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">inv_y</span> <span class="o">-</span> <span class="n">inv_y_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">inv_y</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>
<span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;actual&quot;</span><span class="p">:</span> <span class="n">inv_y</span><span class="p">[:</span><span class="mi">20</span><span class="p">],</span> <span class="s2">&quot;pred&quot;</span><span class="p">:</span> <span class="n">inv_y_pred</span><span class="p">[:</span><span class="mi">20</span><span class="p">],</span><span class="s2">&quot;error%&quot;</span><span class="p">:</span> <span class="n">error_per</span><span class="p">[:</span><span class="mi">20</span><span class="p">]})</span>
<span class="n">df_results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>actual</th>
      <th>pred</th>
      <th>error%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1.009007</td>
      <td>0.960763</td>
      <td>4.781393</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.931919</td>
      <td>0.949959</td>
      <td>1.935785</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.932012</td>
      <td>0.938793</td>
      <td>0.727567</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.932012</td>
      <td>0.942858</td>
      <td>1.163739</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.931919</td>
      <td>0.943097</td>
      <td>1.199466</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.931919</td>
      <td>0.942669</td>
      <td>1.153525</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.931919</td>
      <td>0.945217</td>
      <td>1.426867</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.931919</td>
      <td>0.946274</td>
      <td>1.540318</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.931919</td>
      <td>0.947755</td>
      <td>1.699238</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.997783</td>
      <td>0.962416</td>
      <td>3.544494</td>
    </tr>
    <tr>
      <th>10</th>
      <td>1.019953</td>
      <td>0.992426</td>
      <td>2.698936</td>
    </tr>
    <tr>
      <th>11</th>
      <td>0.931827</td>
      <td>0.989377</td>
      <td>6.176065</td>
    </tr>
    <tr>
      <th>12</th>
      <td>0.931919</td>
      <td>0.938539</td>
      <td>0.710342</td>
    </tr>
    <tr>
      <th>13</th>
      <td>0.931919</td>
      <td>0.936664</td>
      <td>0.509089</td>
    </tr>
    <tr>
      <th>14</th>
      <td>0.931919</td>
      <td>0.940871</td>
      <td>0.960540</td>
    </tr>
    <tr>
      <th>15</th>
      <td>0.931919</td>
      <td>0.946738</td>
      <td>1.590127</td>
    </tr>
    <tr>
      <th>16</th>
      <td>0.931827</td>
      <td>0.949638</td>
      <td>1.911410</td>
    </tr>
    <tr>
      <th>17</th>
      <td>1.012161</td>
      <td>0.950645</td>
      <td>6.077679</td>
    </tr>
    <tr>
      <th>18</th>
      <td>1.027232</td>
      <td>0.989043</td>
      <td>3.717586</td>
    </tr>
    <tr>
      <th>19</th>
      <td>0.974499</td>
      <td>0.992177</td>
      <td>1.814145</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section id="deepar-amazon-timeseries-algorithm">
<h3><em><strong>3.2.3.DeepAR(Amazon timeseries algorithm):</strong></em><a class="headerlink" href="#deepar-amazon-timeseries-algorithm" title="Link to this heading">#</a></h3>
<p>For advanced time-series forecasting, Amazon Corporation developed a state-of-the-art probabilistic forecasting algorithm which is known as the Deep Autoregressive or DeepAR forecasting algorithm. This is one kind of Deep Learning model that is specifically designed to capture the inherent uncertainties associated with future predictions. Unlike traditional forecasting methods that rely on deterministic point estimates, DeepAR provides a probability distribution over future values, allowing decision-makers to assess the range of possible outcomes and make more informed decisions.
DeepAR is powerful algorithm, which has gained prominence for its effectiveness in handling complex temporal patterns and generating accurate forecasts. DeepAR is particularly well-suited for scenarios where multiple related time series need to be forecasted simultaneously, making it a valuable tool in various domains like finance, e-commerce, and supply chain management.</p>
<p>DeepAR is a time series forecasting model with the following key working principles:</p>
<p><em><strong>Autoregressive Architecture:</strong></em>  DeepAR employs an autoregressive neural network architecture, where the predictions for each time step depend on a combination of historical observations and <em><strong>the model’s own past predictions</strong></em>. This enables the algorithm to capture more complex dependencies within the time series data, making it adept at handling sequences with intricate patterns and trends.<br>
<em><strong>Embedding of Categorical Features:</strong></em> DeepAR can seamlessly incorporate information from categorical features associated with time series data. This is achieved through the use of embeddings, which transform categorical variables into continuous vectors. The inclusion of such features enhances the model’s ability to discern patterns and relationships within the data, especially in scenarios where external factors influence the time series.<br>
<em><strong>Temporal Attention Mechanism:</strong></em> To effectively weigh the importance of different time points in the historical data, DeepAR utilizes a temporal attention mechanism. This mechanism enables the model to focus on relevant portions of the time series, adapting its attention dynamically based on the patterns present in the data.<br>
<em><strong>Training with Quantile Loss:</strong></em> DeepAR is trained using a probabilistic approach that minimizes the quantile loss. This means the model is optimized to generate prediction intervals, representing the range of possible future values with associated confidence levels. This probabilistic framework is particularly valuable in decision-making processes, providing decision-makers with a nuanced understanding of the uncertainty associated with the forecasts.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>gluonts
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;gluonts[torch]&quot;</span><span class="w"> </span>#<span class="w"> </span>gluon<span class="w"> </span><span class="nb">time</span><span class="w"> </span>series<span class="w"> </span>library<span class="w"> </span>with<span class="w"> </span>pytorch<span class="w"> </span>backend
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Collecting gluonts
  Downloading gluonts-0.16.0-py3-none-any.whl.metadata (9.8 kB)
Requirement already satisfied: numpy&lt;2.2,&gt;=1.16 in /usr/local/lib/python3.11/dist-packages (from gluonts) (1.26.4)
Requirement already satisfied: pandas&lt;3,&gt;=1.0 in /usr/local/lib/python3.11/dist-packages (from gluonts) (2.2.2)
Requirement already satisfied: pydantic&lt;3,&gt;=1.7 in /usr/local/lib/python3.11/dist-packages (from gluonts) (2.10.6)
Requirement already satisfied: tqdm~=4.23 in /usr/local/lib/python3.11/dist-packages (from gluonts) (4.67.1)
Requirement already satisfied: toolz~=0.10 in /usr/local/lib/python3.11/dist-packages (from gluonts) (0.12.1)
Requirement already satisfied: typing-extensions~=4.0 in /usr/local/lib/python3.11/dist-packages (from gluonts) (4.12.2)
Requirement already satisfied: python-dateutil&gt;=2.8.2 in /usr/local/lib/python3.11/dist-packages (from pandas&lt;3,&gt;=1.0-&gt;gluonts) (2.8.2)
Requirement already satisfied: pytz&gt;=2020.1 in /usr/local/lib/python3.11/dist-packages (from pandas&lt;3,&gt;=1.0-&gt;gluonts) (2025.1)
Requirement already satisfied: tzdata&gt;=2022.7 in /usr/local/lib/python3.11/dist-packages (from pandas&lt;3,&gt;=1.0-&gt;gluonts) (2025.1)
Requirement already satisfied: annotated-types&gt;=0.6.0 in /usr/local/lib/python3.11/dist-packages (from pydantic&lt;3,&gt;=1.7-&gt;gluonts) (0.7.0)
Requirement already satisfied: pydantic-core==2.27.2 in /usr/local/lib/python3.11/dist-packages (from pydantic&lt;3,&gt;=1.7-&gt;gluonts) (2.27.2)
Requirement already satisfied: six&gt;=1.5 in /usr/local/lib/python3.11/dist-packages (from python-dateutil&gt;=2.8.2-&gt;pandas&lt;3,&gt;=1.0-&gt;gluonts) (1.17.0)
Downloading gluonts-0.16.0-py3-none-any.whl (1.5 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">1.5/1.5 MB</span> <span class=" -Color -Color-Red">25.1 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
?25hInstalling collected packages: gluonts
Successfully installed gluonts-0.16.0
Requirement already satisfied: gluonts[torch] in /usr/local/lib/python3.11/dist-packages (0.16.0)
Requirement already satisfied: numpy&lt;2.2,&gt;=1.16 in /usr/local/lib/python3.11/dist-packages (from gluonts[torch]) (1.26.4)
Requirement already satisfied: pandas&lt;3,&gt;=1.0 in /usr/local/lib/python3.11/dist-packages (from gluonts[torch]) (2.2.2)
Requirement already satisfied: pydantic&lt;3,&gt;=1.7 in /usr/local/lib/python3.11/dist-packages (from gluonts[torch]) (2.10.6)
Requirement already satisfied: tqdm~=4.23 in /usr/local/lib/python3.11/dist-packages (from gluonts[torch]) (4.67.1)
Requirement already satisfied: toolz~=0.10 in /usr/local/lib/python3.11/dist-packages (from gluonts[torch]) (0.12.1)
Requirement already satisfied: typing-extensions~=4.0 in /usr/local/lib/python3.11/dist-packages (from gluonts[torch]) (4.12.2)
Requirement already satisfied: torch&lt;3,&gt;=1.9 in /usr/local/lib/python3.11/dist-packages (from gluonts[torch]) (2.5.1+cu124)
Collecting lightning&lt;2.5,&gt;=2.2.2 (from gluonts[torch])
  Downloading lightning-2.4.0-py3-none-any.whl.metadata (38 kB)
Collecting pytorch-lightning&lt;2.5,&gt;=2.2.2 (from gluonts[torch])
  Downloading pytorch_lightning-2.4.0-py3-none-any.whl.metadata (21 kB)
Requirement already satisfied: scipy~=1.10 in /usr/local/lib/python3.11/dist-packages (from gluonts[torch]) (1.13.1)
Requirement already satisfied: PyYAML&lt;8.0,&gt;=5.4 in /usr/local/lib/python3.11/dist-packages (from lightning&lt;2.5,&gt;=2.2.2-&gt;gluonts[torch]) (6.0.2)
Requirement already satisfied: fsspec&lt;2026.0,&gt;=2022.5.0 in /usr/local/lib/python3.11/dist-packages (from fsspec[http]&lt;2026.0,&gt;=2022.5.0-&gt;lightning&lt;2.5,&gt;=2.2.2-&gt;gluonts[torch]) (2024.10.0)
Collecting lightning-utilities&lt;2.0,&gt;=0.10.0 (from lightning&lt;2.5,&gt;=2.2.2-&gt;gluonts[torch])
  Downloading lightning_utilities-0.14.0-py3-none-any.whl.metadata (5.6 kB)
Requirement already satisfied: packaging&lt;25.0,&gt;=20.0 in /usr/local/lib/python3.11/dist-packages (from lightning&lt;2.5,&gt;=2.2.2-&gt;gluonts[torch]) (24.2)
Collecting torchmetrics&lt;3.0,&gt;=0.7.0 (from lightning&lt;2.5,&gt;=2.2.2-&gt;gluonts[torch])
  Downloading torchmetrics-1.6.2-py3-none-any.whl.metadata (20 kB)
Requirement already satisfied: python-dateutil&gt;=2.8.2 in /usr/local/lib/python3.11/dist-packages (from pandas&lt;3,&gt;=1.0-&gt;gluonts[torch]) (2.8.2)
Requirement already satisfied: pytz&gt;=2020.1 in /usr/local/lib/python3.11/dist-packages (from pandas&lt;3,&gt;=1.0-&gt;gluonts[torch]) (2025.1)
Requirement already satisfied: tzdata&gt;=2022.7 in /usr/local/lib/python3.11/dist-packages (from pandas&lt;3,&gt;=1.0-&gt;gluonts[torch]) (2025.1)
Requirement already satisfied: annotated-types&gt;=0.6.0 in /usr/local/lib/python3.11/dist-packages (from pydantic&lt;3,&gt;=1.7-&gt;gluonts[torch]) (0.7.0)
Requirement already satisfied: pydantic-core==2.27.2 in /usr/local/lib/python3.11/dist-packages (from pydantic&lt;3,&gt;=1.7-&gt;gluonts[torch]) (2.27.2)
Requirement already satisfied: filelock in /usr/local/lib/python3.11/dist-packages (from torch&lt;3,&gt;=1.9-&gt;gluonts[torch]) (3.17.0)
Requirement already satisfied: networkx in /usr/local/lib/python3.11/dist-packages (from torch&lt;3,&gt;=1.9-&gt;gluonts[torch]) (3.4.2)
Requirement already satisfied: jinja2 in /usr/local/lib/python3.11/dist-packages (from torch&lt;3,&gt;=1.9-&gt;gluonts[torch]) (3.1.5)
Collecting nvidia-cuda-nvrtc-cu12==12.4.127 (from torch&lt;3,&gt;=1.9-&gt;gluonts[torch])
  Downloading nvidia_cuda_nvrtc_cu12-12.4.127-py3-none-manylinux2014_x86_64.whl.metadata (1.5 kB)
Collecting nvidia-cuda-runtime-cu12==12.4.127 (from torch&lt;3,&gt;=1.9-&gt;gluonts[torch])
  Downloading nvidia_cuda_runtime_cu12-12.4.127-py3-none-manylinux2014_x86_64.whl.metadata (1.5 kB)
Collecting nvidia-cuda-cupti-cu12==12.4.127 (from torch&lt;3,&gt;=1.9-&gt;gluonts[torch])
  Downloading nvidia_cuda_cupti_cu12-12.4.127-py3-none-manylinux2014_x86_64.whl.metadata (1.6 kB)
Collecting nvidia-cudnn-cu12==9.1.0.70 (from torch&lt;3,&gt;=1.9-&gt;gluonts[torch])
  Downloading nvidia_cudnn_cu12-9.1.0.70-py3-none-manylinux2014_x86_64.whl.metadata (1.6 kB)
Collecting nvidia-cublas-cu12==12.4.5.8 (from torch&lt;3,&gt;=1.9-&gt;gluonts[torch])
  Downloading nvidia_cublas_cu12-12.4.5.8-py3-none-manylinux2014_x86_64.whl.metadata (1.5 kB)
Collecting nvidia-cufft-cu12==11.2.1.3 (from torch&lt;3,&gt;=1.9-&gt;gluonts[torch])
  Downloading nvidia_cufft_cu12-11.2.1.3-py3-none-manylinux2014_x86_64.whl.metadata (1.5 kB)
Collecting nvidia-curand-cu12==10.3.5.147 (from torch&lt;3,&gt;=1.9-&gt;gluonts[torch])
  Downloading nvidia_curand_cu12-10.3.5.147-py3-none-manylinux2014_x86_64.whl.metadata (1.5 kB)
Collecting nvidia-cusolver-cu12==11.6.1.9 (from torch&lt;3,&gt;=1.9-&gt;gluonts[torch])
  Downloading nvidia_cusolver_cu12-11.6.1.9-py3-none-manylinux2014_x86_64.whl.metadata (1.6 kB)
Collecting nvidia-cusparse-cu12==12.3.1.170 (from torch&lt;3,&gt;=1.9-&gt;gluonts[torch])
  Downloading nvidia_cusparse_cu12-12.3.1.170-py3-none-manylinux2014_x86_64.whl.metadata (1.6 kB)
Requirement already satisfied: nvidia-nccl-cu12==2.21.5 in /usr/local/lib/python3.11/dist-packages (from torch&lt;3,&gt;=1.9-&gt;gluonts[torch]) (2.21.5)
Requirement already satisfied: nvidia-nvtx-cu12==12.4.127 in /usr/local/lib/python3.11/dist-packages (from torch&lt;3,&gt;=1.9-&gt;gluonts[torch]) (12.4.127)
Collecting nvidia-nvjitlink-cu12==12.4.127 (from torch&lt;3,&gt;=1.9-&gt;gluonts[torch])
  Downloading nvidia_nvjitlink_cu12-12.4.127-py3-none-manylinux2014_x86_64.whl.metadata (1.5 kB)
Requirement already satisfied: triton==3.1.0 in /usr/local/lib/python3.11/dist-packages (from torch&lt;3,&gt;=1.9-&gt;gluonts[torch]) (3.1.0)
Requirement already satisfied: sympy==1.13.1 in /usr/local/lib/python3.11/dist-packages (from torch&lt;3,&gt;=1.9-&gt;gluonts[torch]) (1.13.1)
Requirement already satisfied: mpmath&lt;1.4,&gt;=1.1.0 in /usr/local/lib/python3.11/dist-packages (from sympy==1.13.1-&gt;torch&lt;3,&gt;=1.9-&gt;gluonts[torch]) (1.3.0)
Requirement already satisfied: aiohttp!=4.0.0a0,!=4.0.0a1 in /usr/local/lib/python3.11/dist-packages (from fsspec[http]&lt;2026.0,&gt;=2022.5.0-&gt;lightning&lt;2.5,&gt;=2.2.2-&gt;gluonts[torch]) (3.11.13)
Requirement already satisfied: setuptools in /usr/local/lib/python3.11/dist-packages (from lightning-utilities&lt;2.0,&gt;=0.10.0-&gt;lightning&lt;2.5,&gt;=2.2.2-&gt;gluonts[torch]) (75.1.0)
Requirement already satisfied: six&gt;=1.5 in /usr/local/lib/python3.11/dist-packages (from python-dateutil&gt;=2.8.2-&gt;pandas&lt;3,&gt;=1.0-&gt;gluonts[torch]) (1.17.0)
Requirement already satisfied: MarkupSafe&gt;=2.0 in /usr/local/lib/python3.11/dist-packages (from jinja2-&gt;torch&lt;3,&gt;=1.9-&gt;gluonts[torch]) (3.0.2)
Requirement already satisfied: aiohappyeyeballs&gt;=2.3.0 in /usr/local/lib/python3.11/dist-packages (from aiohttp!=4.0.0a0,!=4.0.0a1-&gt;fsspec[http]&lt;2026.0,&gt;=2022.5.0-&gt;lightning&lt;2.5,&gt;=2.2.2-&gt;gluonts[torch]) (2.4.6)
Requirement already satisfied: aiosignal&gt;=1.1.2 in /usr/local/lib/python3.11/dist-packages (from aiohttp!=4.0.0a0,!=4.0.0a1-&gt;fsspec[http]&lt;2026.0,&gt;=2022.5.0-&gt;lightning&lt;2.5,&gt;=2.2.2-&gt;gluonts[torch]) (1.3.2)
Requirement already satisfied: attrs&gt;=17.3.0 in /usr/local/lib/python3.11/dist-packages (from aiohttp!=4.0.0a0,!=4.0.0a1-&gt;fsspec[http]&lt;2026.0,&gt;=2022.5.0-&gt;lightning&lt;2.5,&gt;=2.2.2-&gt;gluonts[torch]) (25.1.0)
Requirement already satisfied: frozenlist&gt;=1.1.1 in /usr/local/lib/python3.11/dist-packages (from aiohttp!=4.0.0a0,!=4.0.0a1-&gt;fsspec[http]&lt;2026.0,&gt;=2022.5.0-&gt;lightning&lt;2.5,&gt;=2.2.2-&gt;gluonts[torch]) (1.5.0)
Requirement already satisfied: multidict&lt;7.0,&gt;=4.5 in /usr/local/lib/python3.11/dist-packages (from aiohttp!=4.0.0a0,!=4.0.0a1-&gt;fsspec[http]&lt;2026.0,&gt;=2022.5.0-&gt;lightning&lt;2.5,&gt;=2.2.2-&gt;gluonts[torch]) (6.1.0)
Requirement already satisfied: propcache&gt;=0.2.0 in /usr/local/lib/python3.11/dist-packages (from aiohttp!=4.0.0a0,!=4.0.0a1-&gt;fsspec[http]&lt;2026.0,&gt;=2022.5.0-&gt;lightning&lt;2.5,&gt;=2.2.2-&gt;gluonts[torch]) (0.3.0)
Requirement already satisfied: yarl&lt;2.0,&gt;=1.17.0 in /usr/local/lib/python3.11/dist-packages (from aiohttp!=4.0.0a0,!=4.0.0a1-&gt;fsspec[http]&lt;2026.0,&gt;=2022.5.0-&gt;lightning&lt;2.5,&gt;=2.2.2-&gt;gluonts[torch]) (1.18.3)
Requirement already satisfied: idna&gt;=2.0 in /usr/local/lib/python3.11/dist-packages (from yarl&lt;2.0,&gt;=1.17.0-&gt;aiohttp!=4.0.0a0,!=4.0.0a1-&gt;fsspec[http]&lt;2026.0,&gt;=2022.5.0-&gt;lightning&lt;2.5,&gt;=2.2.2-&gt;gluonts[torch]) (3.10)
Downloading lightning-2.4.0-py3-none-any.whl (810 kB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">811.0/811.0 kB</span> <span class=" -Color -Color-Red">22.8 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
?25hDownloading pytorch_lightning-2.4.0-py3-none-any.whl (815 kB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">815.2/815.2 kB</span> <span class=" -Color -Color-Red">41.8 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
?25hDownloading nvidia_cublas_cu12-12.4.5.8-py3-none-manylinux2014_x86_64.whl (363.4 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">363.4/363.4 MB</span> <span class=" -Color -Color-Red">2.7 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
?25hDownloading nvidia_cuda_cupti_cu12-12.4.127-py3-none-manylinux2014_x86_64.whl (13.8 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">13.8/13.8 MB</span> <span class=" -Color -Color-Red">115.5 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
?25hDownloading nvidia_cuda_nvrtc_cu12-12.4.127-py3-none-manylinux2014_x86_64.whl (24.6 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">24.6/24.6 MB</span> <span class=" -Color -Color-Red">85.1 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
?25hDownloading nvidia_cuda_runtime_cu12-12.4.127-py3-none-manylinux2014_x86_64.whl (883 kB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">883.7/883.7 kB</span> <span class=" -Color -Color-Red">48.4 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
?25hDownloading nvidia_cudnn_cu12-9.1.0.70-py3-none-manylinux2014_x86_64.whl (664.8 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">664.8/664.8 MB</span> <span class=" -Color -Color-Red">2.0 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
?25hDownloading nvidia_cufft_cu12-11.2.1.3-py3-none-manylinux2014_x86_64.whl (211.5 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">211.5/211.5 MB</span> <span class=" -Color -Color-Red">5.5 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
?25hDownloading nvidia_curand_cu12-10.3.5.147-py3-none-manylinux2014_x86_64.whl (56.3 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">56.3/56.3 MB</span> <span class=" -Color -Color-Red">13.9 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
?25hDownloading nvidia_cusolver_cu12-11.6.1.9-py3-none-manylinux2014_x86_64.whl (127.9 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">127.9/127.9 MB</span> <span class=" -Color -Color-Red">7.4 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
?25hDownloading nvidia_cusparse_cu12-12.3.1.170-py3-none-manylinux2014_x86_64.whl (207.5 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">207.5/207.5 MB</span> <span class=" -Color -Color-Red">5.6 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
?25hDownloading nvidia_nvjitlink_cu12-12.4.127-py3-none-manylinux2014_x86_64.whl (21.1 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">21.1/21.1 MB</span> <span class=" -Color -Color-Red">97.2 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
?25hDownloading lightning_utilities-0.14.0-py3-none-any.whl (28 kB)
Downloading torchmetrics-1.6.2-py3-none-any.whl (931 kB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">931.6/931.6 kB</span> <span class=" -Color -Color-Red">60.3 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
?25hInstalling collected packages: nvidia-nvjitlink-cu12, nvidia-curand-cu12, nvidia-cufft-cu12, nvidia-cuda-runtime-cu12, nvidia-cuda-nvrtc-cu12, nvidia-cuda-cupti-cu12, nvidia-cublas-cu12, lightning-utilities, nvidia-cusparse-cu12, nvidia-cudnn-cu12, nvidia-cusolver-cu12, torchmetrics, pytorch-lightning, lightning
  Attempting uninstall: nvidia-nvjitlink-cu12
    Found existing installation: nvidia-nvjitlink-cu12 12.5.82
    Uninstalling nvidia-nvjitlink-cu12-12.5.82:
      Successfully uninstalled nvidia-nvjitlink-cu12-12.5.82
  Attempting uninstall: nvidia-curand-cu12
    Found existing installation: nvidia-curand-cu12 10.3.6.82
    Uninstalling nvidia-curand-cu12-10.3.6.82:
      Successfully uninstalled nvidia-curand-cu12-10.3.6.82
  Attempting uninstall: nvidia-cufft-cu12
    Found existing installation: nvidia-cufft-cu12 11.2.3.61
    Uninstalling nvidia-cufft-cu12-11.2.3.61:
      Successfully uninstalled nvidia-cufft-cu12-11.2.3.61
  Attempting uninstall: nvidia-cuda-runtime-cu12
    Found existing installation: nvidia-cuda-runtime-cu12 12.5.82
    Uninstalling nvidia-cuda-runtime-cu12-12.5.82:
      Successfully uninstalled nvidia-cuda-runtime-cu12-12.5.82
  Attempting uninstall: nvidia-cuda-nvrtc-cu12
    Found existing installation: nvidia-cuda-nvrtc-cu12 12.5.82
    Uninstalling nvidia-cuda-nvrtc-cu12-12.5.82:
      Successfully uninstalled nvidia-cuda-nvrtc-cu12-12.5.82
  Attempting uninstall: nvidia-cuda-cupti-cu12
    Found existing installation: nvidia-cuda-cupti-cu12 12.5.82
    Uninstalling nvidia-cuda-cupti-cu12-12.5.82:
      Successfully uninstalled nvidia-cuda-cupti-cu12-12.5.82
  Attempting uninstall: nvidia-cublas-cu12
    Found existing installation: nvidia-cublas-cu12 12.5.3.2
    Uninstalling nvidia-cublas-cu12-12.5.3.2:
      Successfully uninstalled nvidia-cublas-cu12-12.5.3.2
  Attempting uninstall: nvidia-cusparse-cu12
    Found existing installation: nvidia-cusparse-cu12 12.5.1.3
    Uninstalling nvidia-cusparse-cu12-12.5.1.3:
      Successfully uninstalled nvidia-cusparse-cu12-12.5.1.3
  Attempting uninstall: nvidia-cudnn-cu12
    Found existing installation: nvidia-cudnn-cu12 9.3.0.75
    Uninstalling nvidia-cudnn-cu12-9.3.0.75:
      Successfully uninstalled nvidia-cudnn-cu12-9.3.0.75
  Attempting uninstall: nvidia-cusolver-cu12
    Found existing installation: nvidia-cusolver-cu12 11.6.3.83
    Uninstalling nvidia-cusolver-cu12-11.6.3.83:
      Successfully uninstalled nvidia-cusolver-cu12-11.6.3.83
Successfully installed lightning-2.4.0 lightning-utilities-0.14.0 nvidia-cublas-cu12-12.4.5.8 nvidia-cuda-cupti-cu12-12.4.127 nvidia-cuda-nvrtc-cu12-12.4.127 nvidia-cuda-runtime-cu12-12.4.127 nvidia-cudnn-cu12-9.1.0.70 nvidia-cufft-cu12-11.2.1.3 nvidia-curand-cu12-10.3.5.147 nvidia-cusolver-cu12-11.6.1.9 nvidia-cusparse-cu12-12.3.1.170 nvidia-nvjitlink-cu12-12.4.127 pytorch-lightning-2.4.0 torchmetrics-1.6.2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">gluonts.torch.model.deepar</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeepAREstimator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gluonts.dataset.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">ListDataset</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gluonts.dataset.field_names</span><span class="w"> </span><span class="kn">import</span> <span class="n">FieldName</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gluonts.evaluation.backtest</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_evaluation_predictions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gluonts.evaluation</span><span class="w"> </span><span class="kn">import</span> <span class="n">Evaluator</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="model-defining">
<h2><em><strong>3.3.1.Model defining</strong></em><br><a class="headerlink" href="#model-defining" title="Link to this heading">#</a></h2>
<p>The DeepAR estimator model by defining its various hyper-parameters which are listed below–&gt;<br></p>
<p><strong>freq:</strong> this parameter defines the frequency of the time series data. It represents the number of time steps in one period or cycle of the time series. Our data has minute observations but due to computational time we will resample to hourly, so, the frequency is determined by the variable freq.<br>
<strong>context_length:</strong> This parameter sets the number of time steps that the model uses to learn patterns and dependencies in the historical data. Here it is set to (24 * 5), indicating that the model looks back over a period equivalent to 5 days (by assuming each time step corresponds to an hour).<br>
<strong>prediction_length:</strong> This parameter specifies how far into the future the model should generate predictions. It determines the length of the forecast horizon.<br>
<strong>cardinality:</strong> This parameter is a list that indicates the number of categories for each categorical feature in the dataset.
<strong>num_layers:</strong> It determines the number of layers in the neural network architecture. In our case, the model is configured with 2 layers.<br>
<strong>dropout_rate:</strong> It is a regularization technique that helps prevent overfitting. It represents the fraction of input units to drop out during training. A value of 0.25 means that 25% of the input units will be randomly set to zero during each update.<br>
<strong>trainer_kwargs:</strong> This is a dictionary containing additional arguments for the training process. In our case, it includes: ‘max_epochs’:16, which sets the maximum number of training epochs. An epoch is one complete pass through the entire training dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>pip
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>setuptools
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: pip in /usr/local/lib/python3.10/dist-packages (24.1.2)
Collecting pip
  Downloading pip-25.0.1-py3-none-any.whl.metadata (3.7 kB)
Downloading pip-25.0.1-py3-none-any.whl (1.8 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">1.8/1.8 MB</span> <span class=" -Color -Color-Red">22.6 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>00:010:01
?25hInstalling collected packages: pip
  Attempting uninstall: pip
    Found existing installation: pip 24.1.2
    Uninstalling pip-24.1.2:
      Successfully uninstalled pip-24.1.2
Successfully installed pip-25.0.1
Requirement already satisfied: setuptools in /usr/local/lib/python3.10/dist-packages (75.1.0)
Collecting setuptools
  Downloading setuptools-75.8.2-py3-none-any.whl.metadata (6.7 kB)
Downloading setuptools-75.8.2-py3-none-any.whl (1.2 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">1.2/1.2 MB</span> <span class=" -Color -Color-Red">25.1 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
?25hInstalling collected packages: setuptools
  Attempting uninstall: setuptools
    Found existing installation: setuptools 75.1.0
    Uninstalling setuptools-75.1.0:
      Successfully uninstalled setuptools-75.1.0
<span class=" -Color -Color-Red">ERROR: pip&#39;s dependency resolver does not currently take into account all the packages that are installed. This behaviour is the source of the following dependency conflicts.</span>
<span class=" -Color -Color-Red">pandas-gbq 0.25.0 requires google-api-core&lt;3.0.0dev,&gt;=2.10.2, but you have google-api-core 1.34.1 which is incompatible.</span>
<span class=" -Color -Color-Red">tensorflow-decision-forests 1.10.0 requires tensorflow==2.17.0, but you have tensorflow 2.17.1 which is incompatible.</span>
Successfully installed setuptools-75.8.2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_hourly</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;1H&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(Timestamp(&#39;2006-12-16 17:00:00&#39;), Timestamp(&#39;2010-11-26 21:00:00&#39;))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_hourly</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;voltage&#39;, &#39;global_intensity&#39;, &#39;sub_metering_1&#39;, &#39;sub_metering_2&#39;,
       &#39;sub_metering_3&#39;, &#39;power_factor&#39;],
      dtype=&#39;object&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">gluonts.dataset.field_names</span><span class="w"> </span><span class="kn">import</span> <span class="n">FieldName</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gluonts.dataset.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">ListDataset</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gluonts.dataset.pandas</span><span class="w"> </span><span class="kn">import</span> <span class="n">PandasDataset</span>

<span class="n">freq</span> <span class="o">=</span> <span class="s2">&quot;1H&quot;</span>  <span class="c1"># rate at which dataset is sampled</span>
<span class="n">start_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;2006-12-16 17:00:00&quot;</span><span class="p">)</span>
<span class="n">start_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;2010-01-01 00:00:00&quot;</span><span class="p">)</span>
<span class="n">prediction_lentgh</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">1</span>  <span class="c1"># Our prediction Length is 1 Day</span>

<span class="c1"># training and testing sets split</span>
<span class="n">df_train</span> <span class="o">=</span> <span class="n">df_hourly</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="s1">&#39;2010-01-01 00:00:00&#39;</span><span class="p">]</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">df_hourly</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_hourly</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="s1">&#39;2010-01-01 00:00:00&#39;</span><span class="p">]</span>

<span class="c1"># Prepare the training and testing datasets for DeepAR</span>

<span class="c1"># Set the target column to &#39;power_factor&#39; and use other columns as features</span>
<span class="n">target_col</span> <span class="o">=</span> <span class="s1">&#39;power_factor&#39;</span>
<span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;voltage&#39;</span><span class="p">,</span> <span class="s1">&#39;global_intensity&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_metering_1&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_metering_2&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_metering_3&#39;</span><span class="p">]</span>


<span class="c1"># Training dataset</span>
<span class="c1"># I used PandasDataset instead of Listdataset above for correct data format,</span>
<span class="n">train_ds</span> <span class="o">=</span> <span class="n">PandasDataset</span><span class="p">(</span>
    <span class="n">df_train</span><span class="p">,</span>
    <span class="n">target</span><span class="o">=</span><span class="n">target_col</span><span class="p">,</span>
    <span class="n">feat_dynamic_real</span><span class="o">=</span><span class="n">feature_cols</span><span class="p">,</span>
    <span class="n">freq</span><span class="o">=</span><span class="n">freq</span>
<span class="p">)</span>

<span class="c1"># Testing dataset</span>
<span class="c1">#  I used PandasDataset instead of Listdataset above for correct data format</span>
<span class="n">test_ds</span> <span class="o">=</span> <span class="n">PandasDataset</span><span class="p">(</span>
    <span class="n">df_test</span><span class="p">,</span>
    <span class="n">target</span><span class="o">=</span><span class="n">target_col</span><span class="p">,</span>
    <span class="n">feat_dynamic_real</span><span class="o">=</span><span class="n">feature_cols</span><span class="p">,</span>
    <span class="n">freq</span><span class="o">=</span><span class="n">freq</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data_entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_ds</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Veri girişi </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">data_entry</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># It is enough to see the first few examples</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Veri girişi 0:
{&#39;start&#39;: Period(&#39;2006-12-16 17:00&#39;, &#39;h&#39;), &#39;target&#39;: array([0.99705199, 0.99951761, 0.99952564, ..., 0.99682769, 0.99641199,
       0.99695724]), &#39;feat_dynamic_real&#39;: array([[234.64388889, 234.58016667, 233.2325    , ..., 236.6415    ,
        237.91383333, 240.07133333],
       [ 18.1       ,  15.6       ,  14.50333333, ...,  12.1       ,
          8.52      ,   6.95666667],
       [  0.        ,   0.        ,   0.        , ...,   0.        ,
          0.        ,   0.        ],
       [  0.52777778,   6.71666667,   1.43333333, ...,   0.35      ,
          0.53333333,   0.        ],
       [ 16.86111111,  16.86666667,  16.68333333, ...,  18.71666667,
         17.98333333,  18.31666667]])}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d_test_entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_ds</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Veri girişi </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">d_test_entry</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># It is enough to see the first few examples</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Veri girişi 0:
{&#39;start&#39;: Period(&#39;2010-01-01 00:00&#39;, &#39;h&#39;), &#39;target&#39;: array([0.98961909, 0.97173193, 0.98150398, ..., 0.99870591, 0.99717618,
       1.        ]), &#39;feat_dynamic_real&#39;: array([[2.41300000e+02, 2.41620667e+02, 2.44012333e+02, ...,
        2.36741000e+02, 2.39396000e+02, 2.39690000e+02],
       [4.47666667e+00, 2.72333333e+00, 2.65333333e+00, ...,
        7.05666667e+00, 4.91333333e+00, 3.80000000e+00],
       [0.00000000e+00, 0.00000000e+00, 0.00000000e+00, ...,
        0.00000000e+00, 0.00000000e+00, 0.00000000e+00],
       [0.00000000e+00, 8.00000000e-01, 0.00000000e+00, ...,
        6.66666667e-02, 1.06666667e+00, 0.00000000e+00],
       [8.51666667e+00, 6.50000000e-01, 6.66666667e-01, ...,
        0.00000000e+00, 0.00000000e+00, 0.00000000e+00]])}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_ds</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Seri </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: Uzunluk = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Seri 0: Uzunluk = 7918
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_ds</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Seri </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: Uzunluk = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Seri 0: Uzunluk = 26671
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># context length is number of time steps will look back(Inspired by the value</span>
<span class="c1"># in the LSTM model I created above and liked the results, I set it as 24 here.)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">gluonts.torch.model.deepar</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeepAREstimator</span>

<span class="n">estimator</span> <span class="o">=</span> <span class="n">DeepAREstimator</span><span class="p">(</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="n">freq</span> <span class="p">,</span>  <span class="c1"># hourly frequens</span>
    <span class="n">prediction_length</span><span class="o">=</span><span class="n">prediction_lentgh</span><span class="p">,</span>  <span class="c1"># The number of periods we want to predict</span>
    <span class="n">context_length</span><span class="o">=</span><span class="mi">24</span><span class="o">*</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Number of periods to be used as history</span>
    <span class="n">num_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="c1"># LSTM layers</span>
    <span class="n">hidden_size</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="c1"># Number of RNN cells for each layer (default: 40)</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>   <span class="c1"># learning rate</span>
    <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">patience</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>  <span class="c1"># Patience parameter for learning rate scheduler (default=10)</span>
    <span class="n">num_feat_dynamic_real</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># number of features except target</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
    <span class="n">trainer_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;max_epochs&#39;</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span><span class="s2">&quot;accelerator&quot;</span><span class="p">:</span> <span class="s2">&quot;gpu&quot;</span><span class="p">,</span> <span class="s2">&quot;devices&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>  <span class="c1"># use only one GPU</span>

<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predictor</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_ds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO: GPU available: True (cuda), used: True
INFO:lightning.pytorch.utilities.rank_zero:GPU available: True (cuda), used: True
INFO: TPU available: False, using: 0 TPU cores
INFO:lightning.pytorch.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO: HPU available: False, using: 0 HPUs
INFO:lightning.pytorch.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO: LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:lightning.pytorch.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO: 
  | Name  | Type        | Params | Mode  | In sizes                                                        | Out sizes   
-------------------------------------------------------------------------------------------------------------------------------
0 | model | DeepARModel | 28.4 K | train | [[1, 1], [1, 1], [1, 744, 10], [1, 744], [1, 744], [1, 24, 10]] | [1, 100, 24]
-------------------------------------------------------------------------------------------------------------------------------
28.4 K    Trainable params
0         Non-trainable params
28.4 K    Total params
0.114     Total estimated model params size (MB)
11        Modules in train mode
0         Modules in eval mode
INFO:lightning.pytorch.callbacks.model_summary:
  | Name  | Type        | Params | Mode  | In sizes                                                        | Out sizes   
-------------------------------------------------------------------------------------------------------------------------------
0 | model | DeepARModel | 28.4 K | train | [[1, 1], [1, 1], [1, 744, 10], [1, 744], [1, 744], [1, 24, 10]] | [1, 100, 24]
-------------------------------------------------------------------------------------------------------------------------------
28.4 K    Trainable params
0         Non-trainable params
28.4 K    Total params
0.114     Total estimated model params size (MB)
11        Modules in train mode
0         Modules in eval mode
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "9af05750b9ca45d89b16b34d3218bf03"}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO: Epoch 0, global step 50: &#39;train_loss&#39; reached 0.33429 (best 0.33429), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=0-step=50.ckpt&#39; as top 1
INFO:lightning.pytorch.utilities.rank_zero:Epoch 0, global step 50: &#39;train_loss&#39; reached 0.33429 (best 0.33429), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=0-step=50.ckpt&#39; as top 1
INFO: Epoch 1, global step 100: &#39;train_loss&#39; reached -1.64799 (best -1.64799), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=1-step=100.ckpt&#39; as top 1
INFO:lightning.pytorch.utilities.rank_zero:Epoch 1, global step 100: &#39;train_loss&#39; reached -1.64799 (best -1.64799), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=1-step=100.ckpt&#39; as top 1
INFO: Epoch 2, global step 150: &#39;train_loss&#39; reached -2.02430 (best -2.02430), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=2-step=150.ckpt&#39; as top 1
INFO:lightning.pytorch.utilities.rank_zero:Epoch 2, global step 150: &#39;train_loss&#39; reached -2.02430 (best -2.02430), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=2-step=150.ckpt&#39; as top 1
INFO: Epoch 3, global step 200: &#39;train_loss&#39; reached -2.07607 (best -2.07607), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=3-step=200.ckpt&#39; as top 1
INFO:lightning.pytorch.utilities.rank_zero:Epoch 3, global step 200: &#39;train_loss&#39; reached -2.07607 (best -2.07607), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=3-step=200.ckpt&#39; as top 1
INFO: Epoch 4, global step 250: &#39;train_loss&#39; reached -2.08267 (best -2.08267), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=4-step=250.ckpt&#39; as top 1
INFO:lightning.pytorch.utilities.rank_zero:Epoch 4, global step 250: &#39;train_loss&#39; reached -2.08267 (best -2.08267), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=4-step=250.ckpt&#39; as top 1
INFO: Epoch 5, global step 300: &#39;train_loss&#39; reached -2.10526 (best -2.10526), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=5-step=300.ckpt&#39; as top 1
INFO:lightning.pytorch.utilities.rank_zero:Epoch 5, global step 300: &#39;train_loss&#39; reached -2.10526 (best -2.10526), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=5-step=300.ckpt&#39; as top 1
INFO: Epoch 6, global step 350: &#39;train_loss&#39; reached -2.15394 (best -2.15394), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=6-step=350.ckpt&#39; as top 1
INFO:lightning.pytorch.utilities.rank_zero:Epoch 6, global step 350: &#39;train_loss&#39; reached -2.15394 (best -2.15394), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=6-step=350.ckpt&#39; as top 1
INFO: Epoch 7, global step 400: &#39;train_loss&#39; reached -2.19856 (best -2.19856), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=7-step=400.ckpt&#39; as top 1
INFO:lightning.pytorch.utilities.rank_zero:Epoch 7, global step 400: &#39;train_loss&#39; reached -2.19856 (best -2.19856), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=7-step=400.ckpt&#39; as top 1
INFO: Epoch 8, global step 450: &#39;train_loss&#39; reached -2.21071 (best -2.21071), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=8-step=450.ckpt&#39; as top 1
INFO:lightning.pytorch.utilities.rank_zero:Epoch 8, global step 450: &#39;train_loss&#39; reached -2.21071 (best -2.21071), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=8-step=450.ckpt&#39; as top 1
INFO: Epoch 9, global step 500: &#39;train_loss&#39; reached -2.24129 (best -2.24129), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=9-step=500.ckpt&#39; as top 1
INFO:lightning.pytorch.utilities.rank_zero:Epoch 9, global step 500: &#39;train_loss&#39; reached -2.24129 (best -2.24129), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=9-step=500.ckpt&#39; as top 1
INFO: Epoch 10, global step 550: &#39;train_loss&#39; was not in top 1
INFO:lightning.pytorch.utilities.rank_zero:Epoch 10, global step 550: &#39;train_loss&#39; was not in top 1
INFO: Epoch 11, global step 600: &#39;train_loss&#39; reached -2.30316 (best -2.30316), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=11-step=600.ckpt&#39; as top 1
INFO:lightning.pytorch.utilities.rank_zero:Epoch 11, global step 600: &#39;train_loss&#39; reached -2.30316 (best -2.30316), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=11-step=600.ckpt&#39; as top 1
INFO: Epoch 12, global step 650: &#39;train_loss&#39; reached -2.30320 (best -2.30320), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=12-step=650.ckpt&#39; as top 1
INFO:lightning.pytorch.utilities.rank_zero:Epoch 12, global step 650: &#39;train_loss&#39; reached -2.30320 (best -2.30320), saving model to &#39;/content/lightning_logs/version_0/checkpoints/epoch=12-step=650.ckpt&#39; as top 1
INFO: Epoch 13, global step 700: &#39;train_loss&#39; was not in top 1
INFO:lightning.pytorch.utilities.rank_zero:Epoch 13, global step 700: &#39;train_loss&#39; was not in top 1
INFO: Epoch 14, global step 750: &#39;train_loss&#39; was not in top 1
INFO:lightning.pytorch.utilities.rank_zero:Epoch 14, global step 750: &#39;train_loss&#39; was not in top 1
INFO: Epoch 15, global step 800: &#39;train_loss&#39; was not in top 1
INFO:lightning.pytorch.utilities.rank_zero:Epoch 15, global step 800: &#39;train_loss&#39; was not in top 1
INFO: `Trainer.fit` stopped: `max_epochs=16` reached.
INFO:lightning.pytorch.utilities.rank_zero:`Trainer.fit` stopped: `max_epochs=16` reached.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">predictor</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;gluonts.torch.model.predictor.PyTorchPredictor&#39;&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>

<span class="c1"># Eğitilmiş modeli kaydetme</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;deepar_predictor.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Predictor saved successfully!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Predictor saved successfully!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># DeepAR itself provides a wide range of performance metrics like quantile loss, MAPE etc.</span>
<span class="c1"># Convert test data and predictions to iterator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;mxnet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">forecast_iterator</span><span class="p">,</span> <span class="n">test_iterator</span> <span class="o">=</span> <span class="n">make_evaluation_predictions</span><span class="p">(</span>
    <span class="n">dataset</span><span class="o">=</span><span class="n">test_ds</span><span class="p">,</span>
    <span class="n">predictor</span><span class="o">=</span><span class="n">predictor</span><span class="p">,</span>
    <span class="n">num_samples</span><span class="o">=</span><span class="mi">100</span>  <span class="c1"># Monte Carlo sampling number</span>
<span class="p">)</span>

<span class="n">evaluator</span> <span class="o">=</span> <span class="n">Evaluator</span><span class="p">(</span><span class="n">quantiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">agg_metrics</span><span class="p">,</span> <span class="n">item_metrics</span> <span class="o">=</span> <span class="n">evaluator</span><span class="p">(</span><span class="n">test_iterator</span><span class="p">,</span> <span class="n">forecast_iterator</span><span class="p">,</span><span class="n">num_series</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">item_metrics</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Running evaluation: 1it [00:00, 12.54it/s]
</pre></div>
</div>
<div class="output text_html">
  <div id="df-5b095623-ba07-4a76-9f39-2a4266afd1f5" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>item_id</th>
      <th>forecast_start</th>
      <th>MSE</th>
      <th>abs_error</th>
      <th>abs_target_sum</th>
      <th>abs_target_mean</th>
      <th>seasonal_error</th>
      <th>MASE</th>
      <th>MAPE</th>
      <th>sMAPE</th>
      <th>num_masked_target_values</th>
      <th>ND</th>
      <th>MSIS</th>
      <th>QuantileLoss[0.1]</th>
      <th>Coverage[0.1]</th>
      <th>QuantileLoss[0.5]</th>
      <th>Coverage[0.5]</th>
      <th>QuantileLoss[0.9]</th>
      <th>Coverage[0.9]</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>None</td>
      <td>2010-11-25 22:00</td>
      <td>0.000187</td>
      <td>0.253898</td>
      <td>23.635785</td>
      <td>0.984824</td>
      <td>0.022279</td>
      <td>0.47484</td>
      <td>0.010716</td>
      <td>0.010805</td>
      <td>0.0</td>
      <td>0.010742</td>
      <td>4.510152</td>
      <td>0.167593</td>
      <td>0.0</td>
      <td>0.253898</td>
      <td>0.083333</td>
      <td>0.076333</td>
      <td>0.958333</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-5b095623-ba07-4a76-9f39-2a4266afd1f5')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-5b095623-ba07-4a76-9f39-2a4266afd1f5 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-5b095623-ba07-4a76-9f39-2a4266afd1f5');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


  <div id="id_249cb9bd-8165-4559-84a7-1517647447b3">
    <style>
      .colab-df-generate {
        background-color: #E8F0FE;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: none;
        fill: #1967D2;
        height: 32px;
        padding: 0 0 0 0;
        width: 32px;
      }

      .colab-df-generate:hover {
        background-color: #E2EBFA;
        box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
        fill: #174EA6;
      }

      [theme=dark] .colab-df-generate {
        background-color: #3B4455;
        fill: #D2E3FC;
      }

      [theme=dark] .colab-df-generate:hover {
        background-color: #434B5C;
        box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
        filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
        fill: #FFFFFF;
      }
    </style>
    <button class="colab-df-generate" onclick="generateWithVariable('item_metrics')"
            title="Generate code using this dataframe."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px">
    <path d="M7,19H8.4L18.45,9,17,7.55,7,17.6ZM5,21V16.75L18.45,3.32a2,2,0,0,1,2.83,0l1.4,1.43a1.91,1.91,0,0,1,.58,1.4,1.91,1.91,0,0,1-.58,1.4L9.25,21ZM18.45,9,17,7.55Zm-12,3A5.31,5.31,0,0,0,4.9,8.1,5.31,5.31,0,0,0,1,6.5,5.31,5.31,0,0,0,4.9,4.9,5.31,5.31,0,0,0,6.5,1,5.31,5.31,0,0,0,8.1,4.9,5.31,5.31,0,0,0,12,6.5,5.46,5.46,0,0,0,6.5,12Z"/>
  </svg>
    </button>
    <script>
      (() => {
      const buttonEl =
        document.querySelector('#id_249cb9bd-8165-4559-84a7-1517647447b3 button.colab-df-generate');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      buttonEl.onclick = () => {
        google.colab.notebook.generateWithVariable('item_metrics');
      }
      })();
    </script>
  </div>

    </div>
  </div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">item_metrics</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-a5ba2d3a-b9e9-4d15-a866-8c9f728b09e2" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>item_id</th>
      <td>None</td>
    </tr>
    <tr>
      <th>forecast_start</th>
      <td>2010-11-25 22:00</td>
    </tr>
    <tr>
      <th>MSE</th>
      <td>0.000187</td>
    </tr>
    <tr>
      <th>abs_error</th>
      <td>0.253898</td>
    </tr>
    <tr>
      <th>abs_target_sum</th>
      <td>23.635785</td>
    </tr>
    <tr>
      <th>abs_target_mean</th>
      <td>0.984824</td>
    </tr>
    <tr>
      <th>seasonal_error</th>
      <td>0.022279</td>
    </tr>
    <tr>
      <th>MASE</th>
      <td>0.47484</td>
    </tr>
    <tr>
      <th>MAPE</th>
      <td>0.010716</td>
    </tr>
    <tr>
      <th>sMAPE</th>
      <td>0.010805</td>
    </tr>
    <tr>
      <th>num_masked_target_values</th>
      <td>0.0</td>
    </tr>
    <tr>
      <th>ND</th>
      <td>0.010742</td>
    </tr>
    <tr>
      <th>MSIS</th>
      <td>4.510152</td>
    </tr>
    <tr>
      <th>QuantileLoss[0.1]</th>
      <td>0.167593</td>
    </tr>
    <tr>
      <th>Coverage[0.1]</th>
      <td>0.0</td>
    </tr>
    <tr>
      <th>QuantileLoss[0.5]</th>
      <td>0.253898</td>
    </tr>
    <tr>
      <th>Coverage[0.5]</th>
      <td>0.083333</td>
    </tr>
    <tr>
      <th>QuantileLoss[0.9]</th>
      <td>0.076333</td>
    </tr>
    <tr>
      <th>Coverage[0.9]</th>
      <td>0.958333</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-a5ba2d3a-b9e9-4d15-a866-8c9f728b09e2')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-a5ba2d3a-b9e9-4d15-a866-8c9f728b09e2 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-a5ba2d3a-b9e9-4d15-a866-8c9f728b09e2');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-87e4252d-2174-425e-94df-bde2976aef02">
  <button class="colab-df-quickchart" onclick="quickchart('df-87e4252d-2174-425e-94df-bde2976aef02')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-87e4252d-2174-425e-94df-bde2976aef02 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">agg_metrics</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;MSE&#39;: 0.0001867910498569422,
 &#39;abs_error&#39;: 0.25389758425244446,
 &#39;abs_target_sum&#39;: 23.635784652295484,
 &#39;abs_target_mean&#39;: 0.9848243605123118,
 &#39;seasonal_error&#39;: 0.022279241655652798,
 &#39;MASE&#39;: 0.4748395916713955,
 &#39;MAPE&#39;: 0.010715698821678213,
 &#39;sMAPE&#39;: 0.010804822673698792,
 &#39;MSIS&#39;: 4.510152134598325,
 &#39;num_masked_target_values&#39;: 0.0,
 &#39;QuantileLoss[0.1]&#39;: 0.16759295989330117,
 &#39;Coverage[0.1]&#39;: 0.0,
 &#39;QuantileLoss[0.5]&#39;: 0.25389758425244446,
 &#39;Coverage[0.5]&#39;: 0.08333333333333333,
 &#39;QuantileLoss[0.9]&#39;: 0.07633261286748215,
 &#39;Coverage[0.9]&#39;: 0.9583333333333334,
 &#39;RMSE&#39;: 0.013667152221913028,
 &#39;NRMSE&#39;: 0.0138777560445431,
 &#39;ND&#39;: 0.01074208400472062,
 &#39;wQuantileLoss[0.1]&#39;: 0.007090645068854302,
 &#39;wQuantileLoss[0.5]&#39;: 0.01074208400472062,
 &#39;wQuantileLoss[0.9]&#39;: 0.0032295358072687804,
 &#39;mean_absolute_QuantileLoss&#39;: 0.1659410523377426,
 &#39;mean_wQuantileLoss&#39;: 0.0070207549602812344,
 &#39;MAE_Coverage&#39;: 0.4583333333333334,
 &#39;OWA&#39;: nan}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># View results</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\033</span><span class="s2">[1mAggregate Metrics:</span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">agg_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: </span><span class="se">\033</span><span class="s2">[92m</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\033</span><span class="s2">[1mItem Metrics:</span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">item_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: </span><span class="se">\033</span><span class="s2">[92m</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">Aggregate Metrics:</span>
MSE: 0.0001867910498569422
abs_error: 0.25389758425244446
abs_target_sum: 23.635784652295484
abs_target_mean: 0.9848243605123118
seasonal_error: 0.022279241655652798
MASE: 0.4748395916713955
MAPE: 0.010715698821678213
sMAPE: 0.010804822673698792
MSIS: 4.510152134598325
num_masked_target_values: 0.0
QuantileLoss[0.1]: 0.16759295989330117
Coverage[0.1]: 0.0
QuantileLoss[0.5]: 0.25389758425244446
Coverage[0.5]: 0.08333333333333333
QuantileLoss[0.9]: 0.07633261286748215
Coverage[0.9]: 0.9583333333333334
RMSE: 0.013667152221913028
NRMSE: 0.0138777560445431
ND: 0.01074208400472062
wQuantileLoss[0.1]: 0.007090645068854302
wQuantileLoss[0.5]: 0.01074208400472062
wQuantileLoss[0.9]: 0.0032295358072687804
mean_absolute_QuantileLoss: 0.1659410523377426
mean_wQuantileLoss: 0.0070207549602812344
MAE_Coverage: 0.4583333333333334
OWA: nan

<span class=" -Color -Color-Bold">Item Metrics:</span>
item_id: 0    None
Name: item_id, dtype: object
forecast_start: 0    2010-11-25 22:00
Name: forecast_start, dtype: period[h]
MSE: 0    0.000187
Name: MSE, dtype: float64
abs_error: 0    0.253898
Name: abs_error, dtype: float64
abs_target_sum: 0    23.635785
Name: abs_target_sum, dtype: float64
abs_target_mean: 0    0.984824
Name: abs_target_mean, dtype: float64
seasonal_error: 0    0.022279
Name: seasonal_error, dtype: float64
MASE: 0    0.47484
Name: MASE, dtype: float64
MAPE: 0    0.010716
Name: MAPE, dtype: float64
sMAPE: 0    0.010805
Name: sMAPE, dtype: float64
num_masked_target_values: 0    0.0
Name: num_masked_target_values, dtype: float64
ND: 0    0.010742
Name: ND, dtype: float64
MSIS: 0    4.510152
Name: MSIS, dtype: float64
QuantileLoss[0.1]: 0    0.167593
Name: QuantileLoss[0.1], dtype: float64
Coverage[0.1]: 0    0.0
Name: Coverage[0.1], dtype: float64
QuantileLoss[0.5]: 0    0.253898
Name: QuantileLoss[0.5], dtype: float64
Coverage[0.5]: 0    0.083333
Name: Coverage[0.5], dtype: float64
QuantileLoss[0.9]: 0    0.076333
Name: QuantileLoss[0.9], dtype: float64
Coverage[0.9]: 0    0.958333
Name: Coverage[0.9], dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>


<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;deepar_item_metrics.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">item_metrics</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>


<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;deepar_agg_metrics.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">agg_metrics</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>

<span class="c1"># Forecast iterator&#39;ı kaydet</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;forecast_iterator.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">forecast_iterator</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span>

<span class="c1"># Test iterator&#39;ı kaydet</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;test_iterator.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">test_iterator</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;forecast_iterator ve test_iterator saved successfully!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>forecast_iterator ve test_iterator saved successfully!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>

<span class="c1"># First create the forecasts and test data iterators</span>
<span class="n">forecast_iterator</span><span class="p">,</span> <span class="n">test_iterator</span> <span class="o">=</span> <span class="n">make_evaluation_predictions</span><span class="p">(</span>
    <span class="n">dataset</span><span class="o">=</span><span class="n">test_ds</span><span class="p">,</span>
    <span class="n">predictor</span><span class="o">=</span><span class="n">predictor</span><span class="p">,</span>
    <span class="n">num_samples</span><span class="o">=</span><span class="mi">100</span>  <span class="c1"># Monte Carlo sampling number</span>
<span class="p">)</span>

<span class="c1"># Convert iterators to lists to avoid consuming them</span>
<span class="n">forecasts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">forecast_iterator</span><span class="p">)</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_iterator</span><span class="p">)</span>

<span class="c1"># Initialize empty lists to store the data</span>
<span class="n">timestamps</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">actual_values</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">predicted_values</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">lower_bounds</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">upper_bounds</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Helper function to safely get attributes, handling methods vs properties</span>
<span class="k">def</span><span class="w"> </span><span class="nf">safe_get_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Safely get attribute value, handling case where it might be a method&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">attr</span><span class="p">()</span>  <span class="c1"># Call the method if it&#39;s callable</span>
        <span class="k">return</span> <span class="n">attr</span>  <span class="c1"># Return the value if it&#39;s not callable</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error accessing </span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># Process each forecast and test entry pair</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">test_entry</span><span class="p">,</span> <span class="n">forecast</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">forecasts</span><span class="p">)):</span>
    <span class="c1"># Get forecast mean safely</span>
    <span class="n">forecast_mean</span> <span class="o">=</span> <span class="n">safe_get_attr</span><span class="p">(</span><span class="n">forecast</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">forecast_mean</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">forecast_mean</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Forecast </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> has no mean values, skipping&quot;</span><span class="p">)</span>
        <span class="k">continue</span>

    <span class="c1"># Get the start date and target based on test_entry type</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">target</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test_entry</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="c1"># Dictionary format</span>
        <span class="n">start_val</span> <span class="o">=</span> <span class="n">test_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">start_val</span><span class="p">,</span> <span class="s2">&quot;to_timestamp&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">start_val</span><span class="p">,</span> <span class="s2">&quot;to_timestamp&quot;</span><span class="p">)):</span>
                <span class="n">start_date</span> <span class="o">=</span> <span class="n">start_val</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;start&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">start_val</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">test_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test_entry</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="c1"># DataFrame format</span>
        <span class="k">if</span> <span class="s1">&#39;start&#39;</span> <span class="ow">in</span> <span class="n">test_entry</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">start_val</span> <span class="o">=</span> <span class="n">test_entry</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">start_val</span><span class="p">,</span> <span class="s2">&quot;to_timestamp&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">start_val</span><span class="p">,</span> <span class="s2">&quot;to_timestamp&quot;</span><span class="p">)):</span>
                <span class="n">start_date</span> <span class="o">=</span> <span class="n">start_val</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;start&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">start_val</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test_entry</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">):</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="n">test_entry</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test_entry</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">PeriodIndex</span><span class="p">):</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="n">test_entry</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;start&#39;</span><span class="p">)</span>

        <span class="c1"># Get target data</span>
        <span class="k">if</span> <span class="s1">&#39;target&#39;</span> <span class="ow">in</span> <span class="n">test_entry</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">test_entry</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">test_entry</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">numeric_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">test_entry</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># GluonTS Entry object or other object</span>
        <span class="n">start_val</span> <span class="o">=</span> <span class="n">safe_get_attr</span><span class="p">(</span><span class="n">test_entry</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">start_val</span><span class="p">,</span> <span class="s2">&quot;to_timestamp&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">start_val</span><span class="p">,</span> <span class="s2">&quot;to_timestamp&quot;</span><span class="p">)):</span>
                <span class="n">start_date</span> <span class="o">=</span> <span class="n">start_val</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;start&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">start_val</span><span class="p">)</span>

        <span class="n">target_val</span> <span class="o">=</span> <span class="n">safe_get_attr</span><span class="p">(</span><span class="n">test_entry</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">target_val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># If start_date is still None, try to get it from the forecast</span>
    <span class="k">if</span> <span class="n">start_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">start_val</span> <span class="o">=</span> <span class="n">safe_get_attr</span><span class="p">(</span><span class="n">forecast</span><span class="p">,</span> <span class="s1">&#39;start_date&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">start_val</span><span class="p">,</span> <span class="s2">&quot;to_timestamp&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">start_val</span><span class="p">,</span> <span class="s2">&quot;to_timestamp&quot;</span><span class="p">)):</span>
                <span class="n">start_date</span> <span class="o">=</span> <span class="n">start_val</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;start&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">start_val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Last resort - use current time</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="c1"># Ensure start_date has the right frequency</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="s1">&#39;freq&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">start_date</span><span class="o">.</span><span class="n">freq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;start&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error setting frequency: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;start&#39;</span><span class="p">)</span>

    <span class="c1"># Create time range</span>
    <span class="n">time_range</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">forecast_mean</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;H&quot;</span><span class="p">)</span>

    <span class="c1"># Get actual values for forecast period</span>
    <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">forecast_mean</span><span class="p">):</span>
            <span class="n">actual_data</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">forecast_mean</span><span class="p">):]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">actual_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">forecast_mean</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">actual_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">forecast_mean</span><span class="p">)</span>

    <span class="c1"># Add data to lists</span>
    <span class="n">timestamps</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span>
    <span class="n">actual_values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">actual_data</span><span class="p">)</span>
    <span class="n">predicted_values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">forecast_mean</span><span class="p">)</span>

    <span class="c1"># Get quantiles safely</span>
    <span class="n">quantiles</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">forecast</span><span class="p">,</span> <span class="s1">&#39;quantiles&#39;</span><span class="p">):</span>
        <span class="n">quantiles</span> <span class="o">=</span> <span class="n">safe_get_attr</span><span class="p">(</span><span class="n">forecast</span><span class="p">,</span> <span class="s1">&#39;quantiles&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">forecast</span><span class="p">,</span> <span class="s1">&#39;quantile&#39;</span><span class="p">):</span>
        <span class="n">quantiles</span> <span class="o">=</span> <span class="n">safe_get_attr</span><span class="p">(</span><span class="n">forecast</span><span class="p">,</span> <span class="s1">&#39;quantile&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">quantiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Handle different key formats</span>
        <span class="k">if</span> <span class="s2">&quot;0.1&quot;</span> <span class="ow">in</span> <span class="n">quantiles</span><span class="p">:</span>
            <span class="n">lower_bounds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">quantiles</span><span class="p">[</span><span class="s2">&quot;0.1&quot;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="mf">0.1</span> <span class="ow">in</span> <span class="n">quantiles</span><span class="p">:</span>
            <span class="n">lower_bounds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">quantiles</span><span class="p">[</span><span class="mf">0.1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lower_bounds</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">forecast_mean</span><span class="p">))</span>

        <span class="k">if</span> <span class="s2">&quot;0.9&quot;</span> <span class="ow">in</span> <span class="n">quantiles</span><span class="p">:</span>
            <span class="n">upper_bounds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">quantiles</span><span class="p">[</span><span class="s2">&quot;0.9&quot;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="mf">0.9</span> <span class="ow">in</span> <span class="n">quantiles</span><span class="p">:</span>
            <span class="n">upper_bounds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">quantiles</span><span class="p">[</span><span class="mf">0.9</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">upper_bounds</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">forecast_mean</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Try to compute from samples</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">safe_get_attr</span><span class="p">(</span><span class="n">forecast</span><span class="p">,</span> <span class="s1">&#39;samples&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lower_bounds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">upper_bounds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lower_bounds</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">forecast_mean</span><span class="p">))</span>
            <span class="n">upper_bounds</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">forecast_mean</span><span class="p">))</span>

<span class="c1"># Create the DataFrame</span>
<span class="k">if</span> <span class="n">timestamps</span><span class="p">:</span>
    <span class="n">predictions_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamps</span><span class="p">,</span>
        <span class="s2">&quot;actual&quot;</span><span class="p">:</span> <span class="n">actual_values</span><span class="p">,</span>
        <span class="s2">&quot;forecast&quot;</span><span class="p">:</span> <span class="n">predicted_values</span><span class="p">,</span>
        <span class="s2">&quot;lower_bound&quot;</span><span class="p">:</span> <span class="n">lower_bounds</span><span class="p">,</span>
        <span class="s2">&quot;upper_bound&quot;</span><span class="p">:</span> <span class="n">upper_bounds</span>
    <span class="p">})</span>

    <span class="c1"># Display the first few rows of the predictions</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">predictions_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">24</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No data was collected. Check if test_ds and predictor contain valid data.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Error accessing quantile: SampleForecast.quantile() missing 1 required positional argument: &#39;q&#39;
             timestamp    actual  forecast  lower_bound  upper_bound
0  2010-01-01 00:00:00  0.996001  0.979109     0.957283     1.006236
1  2010-01-01 01:00:00  0.978795  0.977442     0.954591     1.006691
2  2010-01-01 02:00:00  0.957529  0.948352     0.919065     0.973969
3  2010-01-01 03:00:00  0.955884  0.949233     0.923243     0.977939
4  2010-01-01 04:00:00  0.961313  0.947737     0.918512     0.974363
5  2010-01-01 05:00:00  0.959853  0.944794     0.912834     0.975269
6  2010-01-01 06:00:00  0.946559  0.950407     0.924151     0.978319
7  2010-01-01 07:00:00  0.976189  0.952891     0.924589     0.983143
8  2010-01-01 08:00:00  0.981559  0.969212     0.940852     1.000487
9  2010-01-01 09:00:00  0.998726  0.991841     0.968545     1.015527
10 2010-01-01 10:00:00  0.997642  0.999866     0.978379     1.026920
11 2010-01-01 11:00:00  0.999054  0.994337     0.975641     1.020473
12 2010-01-01 12:00:00  0.997280  0.994059     0.973197     1.020372
13 2010-01-01 13:00:00  0.995871  0.989874     0.964686     1.011278
14 2010-01-01 14:00:00  0.996982  0.987283     0.956441     1.011556
15 2010-01-01 15:00:00  0.990904  0.982290     0.955774     1.004422
16 2010-01-01 16:00:00  0.994902  0.983917     0.961567     1.007662
17 2010-01-01 17:00:00  0.983324  0.970209     0.936762     0.992772
18 2010-01-01 18:00:00  0.974715  0.966467     0.940950     0.991481
19 2010-01-01 19:00:00  0.998460  0.983270     0.958211     1.005289
20 2010-01-01 20:00:00  0.998358  0.979733     0.955632     1.003662
21 2010-01-01 21:00:00  0.998706  0.982250     0.961187     1.009430
22 2010-01-01 22:00:00  0.997176  0.974580     0.944109     0.999280
23 2010-01-01 23:00:00  1.000000  0.974652     0.946827     0.998513
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># CSV olarak kaydet</span>
<span class="n">predictions_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;deepar_predictions.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tahmin sonuçları &#39;deepar_predictions.csv&#39; olarak kaydedildi.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tahmin sonuçları &#39;deepar_predictions.csv&#39; olarak kaydedildi.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">deepar_pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">predictions_df</span><span class="p">)</span>
<span class="n">deepar_pred</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-2a38b4ce-bd48-42b8-81f2-76dd67bd5b17" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>timestamp</th>
      <th>actual</th>
      <th>forecast</th>
      <th>lower_bound</th>
      <th>upper_bound</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2010-01-01 00:00:00</td>
      <td>0.996001</td>
      <td>0.976457</td>
      <td>0.958705</td>
      <td>0.995681</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2010-01-01 01:00:00</td>
      <td>0.978795</td>
      <td>0.976437</td>
      <td>0.955287</td>
      <td>1.001992</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010-01-01 02:00:00</td>
      <td>0.957529</td>
      <td>0.951684</td>
      <td>0.926935</td>
      <td>0.977410</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010-01-01 03:00:00</td>
      <td>0.955884</td>
      <td>0.954557</td>
      <td>0.925898</td>
      <td>0.984425</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2010-01-01 04:00:00</td>
      <td>0.961313</td>
      <td>0.950160</td>
      <td>0.922957</td>
      <td>0.978759</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2010-01-01 05:00:00</td>
      <td>0.959853</td>
      <td>0.943589</td>
      <td>0.917893</td>
      <td>0.970735</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2010-01-01 06:00:00</td>
      <td>0.946559</td>
      <td>0.952146</td>
      <td>0.924487</td>
      <td>0.984917</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2010-01-01 07:00:00</td>
      <td>0.976189</td>
      <td>0.951244</td>
      <td>0.916098</td>
      <td>0.988962</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2010-01-01 08:00:00</td>
      <td>0.981559</td>
      <td>0.970036</td>
      <td>0.945800</td>
      <td>0.998576</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2010-01-01 09:00:00</td>
      <td>0.998726</td>
      <td>0.995655</td>
      <td>0.967786</td>
      <td>1.026188</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2010-01-01 10:00:00</td>
      <td>0.997642</td>
      <td>0.991938</td>
      <td>0.971878</td>
      <td>1.010007</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2010-01-01 11:00:00</td>
      <td>0.999054</td>
      <td>0.994233</td>
      <td>0.965870</td>
      <td>1.019286</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2010-01-01 12:00:00</td>
      <td>0.997280</td>
      <td>0.992100</td>
      <td>0.969969</td>
      <td>1.012285</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2010-01-01 13:00:00</td>
      <td>0.995871</td>
      <td>0.988688</td>
      <td>0.969284</td>
      <td>1.012631</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2010-01-01 14:00:00</td>
      <td>0.996982</td>
      <td>0.988422</td>
      <td>0.970011</td>
      <td>1.015658</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2010-01-01 15:00:00</td>
      <td>0.990904</td>
      <td>0.984250</td>
      <td>0.960167</td>
      <td>1.009871</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2010-01-01 16:00:00</td>
      <td>0.994902</td>
      <td>0.989652</td>
      <td>0.971864</td>
      <td>1.016590</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2010-01-01 17:00:00</td>
      <td>0.983324</td>
      <td>0.969968</td>
      <td>0.945526</td>
      <td>0.991762</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2010-01-01 18:00:00</td>
      <td>0.974715</td>
      <td>0.966015</td>
      <td>0.941345</td>
      <td>0.989601</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2010-01-01 19:00:00</td>
      <td>0.998460</td>
      <td>0.979268</td>
      <td>0.954377</td>
      <td>1.001490</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2010-01-01 20:00:00</td>
      <td>0.998358</td>
      <td>0.975496</td>
      <td>0.952155</td>
      <td>1.002112</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2010-01-01 21:00:00</td>
      <td>0.998706</td>
      <td>0.982095</td>
      <td>0.954501</td>
      <td>1.008614</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2010-01-01 22:00:00</td>
      <td>0.997176</td>
      <td>0.974572</td>
      <td>0.946131</td>
      <td>1.002155</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2010-01-01 23:00:00</td>
      <td>1.000000</td>
      <td>0.972522</td>
      <td>0.946320</td>
      <td>0.992758</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-2a38b4ce-bd48-42b8-81f2-76dd67bd5b17')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-2a38b4ce-bd48-42b8-81f2-76dd67bd5b17 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-2a38b4ce-bd48-42b8-81f2-76dd67bd5b17');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-f5e603f7-fc15-45f4-ab11-3f86a6ed4fbc">
  <button class="colab-df-quickchart" onclick="quickchart('df-f5e603f7-fc15-45f4-ab11-3f86a6ed4fbc')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-f5e603f7-fc15-45f4-ab11-3f86a6ed4fbc button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.dates</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mdates</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.tsa.seasonal</span><span class="w"> </span><span class="kn">import</span> <span class="n">seasonal_decompose</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>




<span class="c1"># 1. VISUALIZING FORECASTS WITH CONFIDENCE INTERVALS</span>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_forecast_with_intervals</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Electricty Power Factor Predictions with Confidence Intervals&quot;</span><span class="p">,</span>
                                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sample_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the time series forecast with actual values and confidence intervals.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing the forecasts with columns: timestamp, actual, forecast, lower_bound, upper_bound</span>
<span class="sd">    title : str</span>
<span class="sd">        Title of the plot</span>
<span class="sd">    figsize : tuple</span>
<span class="sd">        Figure size (width, height)</span>
<span class="sd">    sample_size : int, optional</span>
<span class="sd">        Number of data points to show (most recent). If None, show all data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create a copy to avoid modifying the original</span>
    <span class="n">plot_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Set timestamp as index if it&#39;s not already</span>
    <span class="k">if</span> <span class="s1">&#39;timestamp&#39;</span> <span class="ow">in</span> <span class="n">plot_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">plot_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Sample the most recent data points if specified</span>
    <span class="k">if</span> <span class="n">sample_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plot_df</span> <span class="o">=</span> <span class="n">plot_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">sample_size</span><span class="p">:]</span>

    <span class="c1"># Create figure and axis</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="c1"># Plot actual values</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

    <span class="c1"># Plot forecast values</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;forecast&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Forecast&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

    <span class="c1"># Plot confidence intervals</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">plot_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;lower_bound&#39;</span><span class="p">],</span> <span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;upper_bound&#39;</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;80% Confidence Interval&#39;</span><span class="p">)</span>

    <span class="c1"># Format x-axis to display dates nicely</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">autofmt_xdate</span><span class="p">()</span>

    <span class="c1"># Add labels and legend</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Timestamp&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Power_Factor&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Compute forecast error statistics</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;forecast&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mse</span><span class="p">)</span>
    <span class="n">mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;forecast&#39;</span><span class="p">]))</span>

    <span class="c1"># Add text with error metrics</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;RMSE: </span><span class="si">{</span><span class="n">rmse</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s1">MAE: </span><span class="si">{</span><span class="n">mae</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>


    <span class="c1"># Calculate grid dimensions</span>
    <span class="n">n_series</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">series_ids</span><span class="p">)</span>
    <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_series</span><span class="p">)</span>
    <span class="n">n_rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_series</span> <span class="o">+</span> <span class="n">n_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">n_cols</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_series</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">axes</span><span class="p">])</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">series_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">series_ids</span><span class="p">):</span>
        <span class="c1"># Filter data for this series</span>
        <span class="n">series_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">id_column</span><span class="p">]</span> <span class="o">==</span> <span class="n">series_id</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">series_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">timestamp_col</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Plot on the corresponding subplot</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Plot actual values</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">series_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">series_df</span><span class="p">[</span><span class="n">actual_col</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

        <span class="c1"># Plot forecast values</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">series_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">series_df</span><span class="p">[</span><span class="n">forecast_col</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Forecast&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

        <span class="c1"># Plot confidence intervals</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">series_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">series_df</span><span class="p">[</span><span class="n">lower_col</span><span class="p">],</span> <span class="n">series_df</span><span class="p">[</span><span class="n">upper_col</span><span class="p">],</span>
                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;80% Confidence Interval&#39;</span><span class="p">)</span>

        <span class="c1"># Format x-axis</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>

        <span class="c1"># Add title and grid</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Series: </span><span class="si">{</span><span class="n">series_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Add legend to only the first subplot</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># Hide any unused subplots</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">autofmt_xdate</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_forecast_with_intervals</span><span class="p">(</span><span class="n">predictions_df</span><span class="p">,</span> <span class="n">sample_size</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>  <span class="c1"># Show last 24 hours</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/042399c5877f71765544ead795982ab8a45950575b9f753a7f99620d50d1b0df.png" src="../_images/042399c5877f71765544ead795982ab8a45950575b9f753a7f99620d50d1b0df.png" />
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="electricity-power-factor-forecast-analysis">
<h1>Electricity Power Factor Forecast Analysis<a class="headerlink" href="#electricity-power-factor-forecast-analysis" title="Link to this heading">#</a></h1>
<p>Here’s my comment about model;</p>
<ol class="arabic simple">
<li><p><strong>Overall Performance</strong>: Our model tracks the actual values (blue line) quite well. The RMSE of 0.0135 and MAE of 0.0108 indicate that the model’s predictions are generally accurate, as these are relatively low error values.</p></li>
<li><p><strong>Daily Pattern</strong>: There’s a clear <em><strong>24-hour diurnal pattern</strong></em> in the electricity power factor. We can observe lower power factor values in the early morning hours (03:00-06:00), higher values during business hours (09:00-15:00), and another decline in the evening hours.</p></li>
<li><p><strong>Prediction Accuracy</strong>: Our model tends to underestimate the power factor during hours with higher values (09:00-15:00). This suggests that the forecasting <em><strong>model isn’t fully capturing some peak values</strong></em>.</p></li>
<li><p><strong>Confidence Intervals</strong>: The 80% confidence interval (pink area) generally encompasses the actual values, but at certain points (especially around 18:00), the actual value comes very close to or slightly exceeds the upper bound. This might indicate time periods with higher uncertainty.</p></li>
<li><p><strong>Night and Morning Hours</strong>: The decrease in power factor during night and early morning hours (00:00-06:00) is likely due to reduced industrial or commercial loads.</p></li>
<li><p><strong>If I need to improve the model, maybe I will try to do the following, maybe in the future</strong>:</p>
<ul class="simple">
<li><p>To improve predictions during business hours (09:00-15:00), consider adding additional features (workday/holiday, seasonal factors).</p></li>
<li><p>The model structure could be reviewed to better capture sudden changes around 18:00.</p></li>
<li><p>The wider confidence intervals during certain hours indicate that prediction is more difficult during these times; separate models for these hours might be worth considering.</p></li>
</ul>
</li>
</ol>
<p><em><strong>Compensation and Energy Efficiency Recommendations:</strong></em>
While the power factor is in good condition during business hours (09:00-15:00), adjusting reactive power compensation systems during early morning hours (03:00-06:00) can increase energy efficiency.
The sudden changes around 18:00 may be related to some industrial loads going offline, and automatic compensation systems can play a more active role during these transition periods.
Time-dependent compensation strategies can be developed for low power factor during night and morning hours.</p>
<p><em><strong>Cost and Penalty Analysis:</strong></em> Many electricity distribution companies impose penalties for low power factor. According to the graph, especially between 03:00-06:00 when the power factor drops below 0.95, potential penalties may be incurred during these hours. Your model can help predict these penalties and take preventive measures.</p>
<p>Overall, our model appears successful at capturing the daily fluctuations in power factor. The <em><strong>low error metrics</strong></em> suggest that the model is sufficiently accurate for practical applications.</p>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./_notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#"><em><strong>About Dataset And Features:</strong></em></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-detailed-description-of-the-dataset-is-given-in-the-notebook-which-is-the-first-of-this-notebook-series-and-in-the-original-location-of-the-dataset-on-kaggle">A detailed description of the dataset is given in the notebook, which is the first of this notebook series, and in the original location of the dataset on Kaggle.</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#importing-libraries"><em><strong>1.Importing Libraries</strong></em></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-data"><em><strong>2.Reading Data</strong></em></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modeling"><em><strong>3.MODELING</strong></em></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-preparation"><em><strong>3.1. Model Preparation</strong></em></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-selection"><em><strong>3.2.Model Selection¶</strong></em></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lstm-long-short-term-memory"><em><strong>3.2.1.LSTM(Long Short Term Memory)</strong></em></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-results-don-t-look-bad-but"><strong>The results don’t look bad but</strong><br/></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#differecence-between-train-test-line-indicates-overfitting-so"><em><strong>Differecence between train-test line indicates overfitting, so</strong></em></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#i-think-it-is-enough-for-lstm"><strong>I think, it is enough for LSTM</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gru"><em><strong>3.2.2.Gru</strong></em></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#gru-gated-recurrent-unit-and-its-key-features"><em><strong><em>GRU (Gated Recurrent Unit) and Its Key Features</em></strong></em><br/><br/></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deepar-amazon-timeseries-algorithm"><em><strong>3.2.3.DeepAR(Amazon timeseries algorithm):</strong></em></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-defining"><em><strong>3.3.1.Model defining</strong></em><br/></a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#electricity-power-factor-forecast-analysis">Electricity Power Factor Forecast Analysis</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Nazım ÇALIK
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>